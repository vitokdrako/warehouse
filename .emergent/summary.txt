<analysis>**original_problem_statement:**
The user has provided a comprehensive technical specification for a complete overhaul of the Finance Hub module. The goal is to build a robust, legally-compliant document management system. The project is divided into phases, with the current focus being Phase 3 and its sub-phases.

**Phase 3: Documents Engine**
-   Distinguish between  (estimate) and  (legal document).
-   Introduce  (annual contracts).
-   Implement  linked to master agreements and orders.
-   Enforce a  to control document availability based on order status and other conditions.
-   Ensure document immutability using a  model, where generated documents are frozen and do not change even if the source order is modified.
-   Integrate this engine into the  UI.

**Phase 3.2: Production-Ready Features**
-   Implement a  component for digital signatures.
-   Create a backend service for PDF generation from HTML templates (using WeasyPrint).
-   Develop a  to allow users to view documents before signing.
-   Create a  to capture user input for specific document fields.
-   Implement  to enforce financial-legal consistency.
-   Add a  to the UI.

The user also provided full legal text and HTML/CSS templates for all required documents.

**User's preferred language**: українська

**what currently exists?**
The foundational backend for the **Phase 3 Documents Engine** is complete and tested. This includes:
-   New database tables: , , , and .
-   API endpoints for creating and managing these entities (, ).
-   A working  () that correctly determines which documents are available for a given order.
-   A  mechanism that creates immutable JSON data for legal documents.
-   A full set of production-grade HTML templates (using Jinja2) for 6 document types (, , , etc.) located in .
-   A backend rendering endpoint () that generates HTML previews from these templates.

On the frontend, the  within  has been significantly updated with sub-tabs for Documents, Agreements, and Annexes, and successfully displays data from the new backend APIs. New components for  and  have been created.

**Last working item**:
-   **Last item agent was working:** The agent was integrating the newly created  into the  page. The goal was to make document buttons (like Generate Quote) open this preview modal instead of directly triggering an action. The agent had added the modal and was in the process of modifying the  handlers for the document buttons to trigger the preview.
-   **Status:** IN PROGRESS
-   **Agent Testing Done:** N
-   **Which testing method agent to use?** frontend testing agent
-   **User Testing Done:** N

**All Pending/In progress Issue list**:
-   **Issue 1: (P1) Moodboard export is likely broken due to a CORS workaround.**
    -   **Description:** Exporting the moodboard as PNG/PDF will likely fail because the  attribute was removed from images.
    -   **Status:** BLOCKED (Requires user to confirm backend deployment of a previous CORS fix).
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** Frontend
    -   **Blocked on other issue:** User confirmation.

-   **Issue 2: (P2) Recurring Calendar Timezone Bug.**
    -   **Description:** A long-standing bug that affects the calendar UI across the application.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** Y
    -   **Should Test frontend/backend/both after fix?** Frontend

-   **Issue 3: (P3) Image 404s in Catalog.**
    -   **Description:** Some product images are not loading in the catalog view.
    -   **Status:** NOT STARTED
    -   **Is recurring issue?** N
    -   **Should Test frontend/backend/both after fix?** Frontend

**In progress Task List**:
-   **Task 1: (P0) Implement Phase 3.2: Production Documents Features**
    -   **Description:** This is the highest priority task, aimed at making the Documents Engine fully production-ready.
    -   **Where to resume:** Resume in . The agent was modifying the  handler of the document generation buttons (inside the  component) to open the  with the correct document type. The next step is to complete this modification and ensure the modal receives the correct props to render the HTML preview.
    -   **What will be achieved with this?** A complete, legally compliant document lifecycle: create -> preview -> sign -> generate PDF -> link to payments.
    -   **Status:** IN PROGRESS
    -   **Should Test frontend/backend/both after fix?** Both
    -   **Blocked on something:** None

**Upcoming and Future Tasks**
-   **Upcoming Tasks:**
    -   **(P0) Phase 3.2 - Manual Fields Form:** Create a UI form to capture manual data required for documents (e.g., contact person, condition notes) before generation.
    -   **(P1) Phase 3.2 - Payment ↔ Annex Linking:** Add an  to the  table and enforce validation to ensure rent payments are linked to a legal annex.
    -   **(P1) Phase 3.2 - Contract Expiration Warning:** Implement UI warnings and backend jobs for expiring master agreements.
    -   **(P1) Phase 3.2 - Email Workflow:** Integrate email sending for documents (e.g., sending a signed copy to the client).
    -   **(P2) Unify Order Workspaces:** Refactor  and  to reduce code duplication.

-   **Future Tasks:**
    -   **(P2) Database Refactoring:** Unify item status tables into a cleaner  and  system.
    -   **(P2) Implement full Role-Based Access Control (RBAC).**
    -   **(P2) Implement Monthly Financial Report.**
    -   **(P3) Digital Signature Integration (Phase 2):** Enhance the existing signature system if required.
    -   **(P3) HR/Ops Module:** Create a separate module for managing employee shifts, check-ins, sick leave, etc.

**Completed work in this session**
-   **Phase 3: Documents Engine - Backend Foundation (DONE):**
    -   Created DB tables , , ,  via migration in .
    -   Implemented API routes for , ,  in their respective files.
    -   Implemented a working Document Policy Matrix to control document availability.
    -   Implemented a snapshot data builder for creating immutable document data.
    -   All backend changes were tested successfully with the testing agent ().

-   **Phase 3.1: Production Document Templates (DONE):**
    -   Created 6 production-ready HTML templates (, , etc.) with partials (, ) in .
    -   Created a backend route  to generate HTML previews from these templates.
    -   Created a placeholder API route  for handling digital signatures.
    -   Created a documentation file .

-   **Phase 3.2: Frontend Integration (IN PROGRESS):**
    -   Rewrote the  in  to include sub-tabs for Agreements and Annexes, fetching and displaying data correctly.
    -   Installed .
    -   Created new components:  and .
    -   Started integrating the preview modal into the  workflow.

**Earlier issues found/mentioned but not fixed**
-   **Issue 1: Login API response key mismatch.**
    -   **Description:** The login API returns , but the frontend might be expecting . This caused some initial UI login issues during testing but was deemed non-blocking for the document engine task.
    -   **Debug checklist:** Check  or similar auth-handling files to see which key is expected from the login response. Adjust either the frontend or the backend () to be consistent.
    -   **Why to solve this issue and what will be achieved with this?** To ensure a stable and predictable authentication flow for the entire application.
    -   **Should Test frontend/backend/both after fix:** Frontend
    -   **Is recurring issue?** N

**Known issue recurrence from previous fork**
-   **Calendar Timezone Bug:**
    -   Recurrence count: 4+
    -   Status: NOT STARTED

**Code Architecture**


**Key Technical Concepts**
-   **Phased Refactoring:** Project execution in distinct, user-approved phases.
-   **API Aggregation (Snapshot Pattern):** Using a single backend endpoint to serve aggregated data.
-   **Immutable Document Snapshots:** Storing a  of order data at the time of document generation to ensure legal integrity.
-   **HTML/CSS Template-based Document Generation:** Using Jinja2 on the backend to render production-ready HTML templates, which will then be converted to PDF.
-   **Digital Signatures:** Capturing user signatures via a canvas on the frontend and saving them as images.

**key DB schema**
-   **** (NEW): 
-   **** (NEW): 
-   **** (NEW): 
-   **** (NEW): 
-   **** (MODIFIED): Added , , .

**changes in tech stack**
-   **Frontend:** Added .
-   **Backend:** Will require 
-----

WeasyPrint could not import some external libraries. Please carefully follow the installation steps before reporting an issue:
https://doc.courtbouillon.org/weasyprint/stable/first_steps.html#installation
https://doc.courtbouillon.org/weasyprint/stable/first_steps.html#troubleshooting 

----- for PDF generation (planning phase).

**All files of reference**
-   **/app/frontend/src/pages/FinanceHub.jsx**: Main UI component being modified.
-   **/app/frontend/src/components/DocumentPreviewModal.jsx**: New modal for previewing/signing.
-   **/app/frontend/src/components/SignatureCanvas.jsx**: New component for capturing signatures.
-   **/app/backend/routes/document_render.py**: New backend for rendering HTML.
-   **/app/backend/routes/document_pdf.py**: New backend for generating PDFs.
-   **/app/backend/routes/document_signatures.py**: New backend for saving signatures.
-   **/app/backend/templates/documents/**: Directory containing all new HTML templates.
-   **/app/backend/server.py**: Modified to include new routes.
-   **/app/backend/routes/migrations.py**: Modified with new table schemas.

**Areas that need refactoring**:
-   The large  (2000+ lines) could be broken down into smaller sub-components for each tab in the future.

**key api endpoints**
-   : **(NEW)** Renders a document's HTML preview.
-   : **(NEW)** Generates a PDF for a document.
-   : **(NEW)** Saves a signature for a document.
-   : **(NEW)** Lists all master agreements.
-   : **(NEW)** Creates a new master agreement.
-   : **(NEW)** Lists annexes for an order.
-   : **(NEW)** Generates a new annex for an order.

**Critical Info for New Agent**
-   **You must communicate in Ukrainian.**
-   Your immediate priority is **Phase 3.2**, continuing the work on the frontend.
-   **Resume work in **. You need to finish wiring the . The goal is for document buttons to open a preview of the HTML document inside this modal.
-   The user has provided extremely detailed, production-level specifications. Follow them closely. The next steps after the preview modal are PDF generation, signature saving, and handling manual input fields.

**documents and test reports created in this job**
-    (Updated with Phase 3 & 3.1 completion and Phase 3.2 roadmap)
-    (Successful backend test report for Phase 3 foundation)

**Last 10 User Messages and any pending HUMAN messages**
1.  **User (Fulfilled):** Provided an extremely detailed production specification for Phase 3.2, including file structures, HTML/CSS templates, data contracts, and implementation order for signatures, PDFs, and payment linking.
2.  **User (Fulfilled):** Confirmed the plan to start Phase 3.2, prioritizing HTML templates, watermarks, and signature canvas.
3.  **User (Fulfilled):** Provided the full legal text for all document templates.
4.  **User (Fulfilled):** Provided the complete technical specification for Phase 3 (Documents Engine), covering data models, APIs, policy rules, and UI requirements.
5.  ... older messages about completing previous phases ...

**Project Health Check:**
-   **Broken:** Moodboard export functionality is likely non-functional.
-   **Mocked:** None.

**3rd Party Integrations**
-   **konva, react-konva:** Used for moodboard canvas.
-   **zustand:** State management.
-   **jspdf, html-to-image:** Used for moodboard export.
-   **mysql-connector-python:** Backend database driver.
-   **lucide-react:** Icon library.
-   **react-signature-canvas:** (NEW) For capturing digital signatures.

**Testing status**
-   **Testing agent used after significant changes:** YES (for backend foundation)
-   **Troubleshoot agent used after agent stuck in loop:** NO
-   **Test files created:** 
-   **Known regressions:** Moodboard export is likely broken.

**Credentials to test flow:**
-   **RentalHub Admin:**  / 

**What agent forgot to execute**
The agent was in the middle of implementing the  integration. The  handler for the document buttons in  was being modified but is not yet complete. The immediate next action is to finish that implementation.</analysis>
