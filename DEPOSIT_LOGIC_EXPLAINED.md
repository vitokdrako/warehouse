# Логіка депозиту: Очікуваний vs Фактичний

## Огляд
Система підтримує два типи депозиту:
1. **Очікуваний депозит** - розрахункова сума, яку система очікує отримати (завжди в UAH)
2. **Фактичний депозит** - реальна сума, яку залишив клієнт (може бути в UAH, USD, EUR)

**ВАЖЛИВО**: Валюти НЕ конвертуються! Система зберігає точно ті гроші, які клієнт залишив.

## Джерела даних

### Очікуваний депозит
- **Джерело**: Таблиця `orders.deposit_amount`
- **Валюта**: Завжди UAH
- **Призначення**: Інформаційне поле для порівняння з фактичним
- **Транзакції**: Тип `deposit_expected` (створюється автоматично при прийнятті замовлення)

### Фактичний депозит
- **Джерело**: Таблиця `finance_transactions` з типом `deposit_hold`
- **Валюта**: UAH, USD, EUR (може бути кілька транзакцій у різних валютах)
- **Призначення**: Використовується у всіх фінансових розрахунках
- **Транзакції**: Створюються вручну менеджером через "Прийняти заставу"

## Реалізація

### Backend
**Файл**: `/app/backend/routes/finance.py`

API endpoint `/api/manager/finance/ledger` тепер повертає:
```python
{
    "id": "...",
    "order_id": 6994,
    "expected_deposit": 800.0,  # З orders.deposit_amount
    "amount": 100.0,
    "currency": "USD",
    "type": "deposit_hold",
    ...
}
```

### Frontend
**Файл**: `/app/frontend/src/pages/FinanceCabinet.jsx`

#### Відображення
```javascript
// Очікуваний депозит (синя картка)
const expectedDeposit = orderRows[0]?.expected_deposit || 0

// Фактичний депозит (зелена картка, мультивалютний)
const heldByCurrency = heldAmountByCurrency(orderRows)
```

#### Розрахунки
Всі фінансові операції використовують **тільки фактичний депозит**:
- `heldAmount(rows)` - сума фактичного холду в UAH
- `heldAmountByCurrency(rows)` - деталізація по валютах
- Операції списання та повернення застави

## Приклади використання

### Приклад 1: Клієнт приніс іншу валюту
```
Замовлення #6991
Очікувана застава: ₴ 7 325 (розрахункова)
Фактична застава: $ 700 USD (прийнято від клієнта)

Пояснення: Система очікувала 7 325 грн, але клієнт приніс долари.
Менеджер прийняв $700, і саме ця сума зберігається на холді БЕЗ конвертації.
```

### Приклад 2: Клієнт приніс євро замість гривень
```
Замовлення #6995
Очікувана застава: ₴ 83 000 (розрахункова)
Фактична застава: € 3 000 EUR (прийнято від клієнта)

Пояснення: Очікувалось 83 тис грн, клієнт приніс євро.
На холді зберігаються саме євро, які потім і будуть повернуті клієнту.
```

### Приклад 3: Мультивалютний депозит
```
Замовлення #6996
Очікувана застава: ₴ 1 510 (розрахункова)
Фактична застава: € 50 EUR + $ 600 USD + ₴ 7 510 (прийнято від клієнта)

Пояснення: Клієнт приніс гроші в трьох валютах, кожна зберігається окремо.
```

### Приклад 4: Клієнт не приніс заставу
```
Замовлення #XXXX
Очікувана застава: ₴ 5 000 (розрахункова)
Фактична застава: — (не прийнято)

Пояснення: Замовлення створено, але клієнт ще не залишив депозит.
```

## Переваги нової логіки

1. ✅ **Прозорість**: Менеджер бачить різницю між розрахунковою і реальною застав
2. ✅ **Мультивалютність**: Підтримка USD, EUR, UAH
3. ✅ **Точність**: Фінансові підсумки базуються на реально отриманих грошах
4. ✅ **Аудит**: Повна історія всіх операцій з заставою

## Технічні деталі

### Функції розрахунку холду
```javascript
// Загальна сума холду (в UAH, для простих розрахунків)
function heldAmount(rows) {
  const hold = rows.filter(isHold).reduce((s,r)=>s+(r.credit||0),0)
  const release = rows.filter(isHoldRelease).reduce((s,r)=>s+(r.amount||0),0)
  const writeoff = rows.filter(isHoldWriteoff).reduce((s,r)=>s+(r.amount||0),0)
  return Math.max(0, hold - release - writeoff)
}

// Детальний холд по валютах
function heldAmountByCurrency(rows) {
  const byCurrency = {}
  rows.forEach(r => {
    const curr = r.currency || 'UAH'
    if (r.type === 'deposit_hold') {
      byCurrency[curr] = (byCurrency[curr] || 0) + (r.credit || 0)
    }
    if (r.type === 'deposit_release' || r.type === 'deposit_writeoff') {
      byCurrency[curr] = (byCurrency[curr] || 0) - (r.amount || 0)
    }
  })
  return byCurrency
}
```

## Майбутні покращення

- [ ] Автоматична конвертація валют за поточним курсом
- [ ] Можливість змінити очікуваний депозит вручну
- [ ] Сповіщення, коли фактичний депозит відрізняється від очікуваного

---

**Створено**: 24.11.2025
**Версія**: 1.0
