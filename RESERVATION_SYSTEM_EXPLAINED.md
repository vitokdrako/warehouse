# üì¶ –°–∏—Å—Ç–µ–º–∞ —Ä–µ–∑–µ—Ä–≤—É–≤–∞–Ω–Ω—è —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ —Ç–æ–≤–∞—Ä—ñ–≤

## üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–∏—Ö

**–ù–∞–∑–≤–∞ –ë–î:** `farforre_rentalhub` (RentalHub MySQL Database)
**–•–æ—Å—Ç:** `farforre.mysql.tools`
**–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è:** –ß–µ—Ä–µ–∑ SQLAlchemy –≤ `/app/backend/database_rentalhub.py`

---

## üìä –ö–ª—é—á–æ–≤—ñ —Ç–∞–±–ª–∏—Ü—ñ

### 1Ô∏è‚É£ **ORDERS** (–î–∂–µ—Ä–µ–ª–æ —ñ—Å—Ç–∏–Ω–∏ –¥–ª—è —Ä–µ–∑–µ—Ä–≤—É–≤–∞–Ω–Ω—è) ‚≠ê

**–ù–∞–π–≤–∞–∂–ª–∏–≤—ñ—à–µ –ø–æ–ª–µ:** `status` (varchar 50)

**–°—Ç–∞—Ç—É—Å–∏, —â–æ –ó–ê–ú–û–†–û–ñ–£–Æ–¢–¨ —Ç–æ–≤–∞—Ä–∏:**
```
‚úÖ 'processing'        - –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –≤ –æ–±—Ä–æ–±—Ü—ñ
‚úÖ 'ready_for_issue'   - –ì–æ—Ç–æ–≤–æ –¥–æ –≤–∏–¥–∞—á—ñ
‚úÖ 'issued'            - –í–∏–¥–∞–Ω–æ –∫–ª—ñ—î–Ω—Ç—É
‚úÖ 'on_rent'           - –í –æ—Ä–µ–Ω–¥—ñ
```

**–°—Ç–∞—Ç—É—Å–∏, —â–æ –†–û–ó–ú–û–†–û–ñ–£–Æ–¢–¨ —Ç–æ–≤–∞—Ä–∏:**
```
‚ùå 'returned'    - –ü–æ–≤–µ—Ä–Ω—É—Ç–æ
‚ùå 'cancelled'   - –°–∫–∞—Å–æ–≤–∞–Ω–æ
‚ùå 'completed'   - –ó–∞–≤–µ—Ä—à–µ–Ω–æ
```

**–Ü–Ω—à—ñ –≤–∞–∂–ª–∏–≤—ñ –ø–æ–ª—è:**
- `order_id` (PK)
- `rental_start_date` - –î–∞—Ç–∞ –ø–æ—á–∞—Ç–∫—É –æ—Ä–µ–Ω–¥–∏
- `rental_end_date` - –î–∞—Ç–∞ –∑–∞–∫—ñ–Ω—á–µ–Ω–Ω—è –æ—Ä–µ–Ω–¥–∏
- `customer_name` - –Ü–º'—è –∫–ª—ñ—î–Ω—Ç–∞

---

### 2Ô∏è‚É£ **ORDER_ITEMS** (–ü–æ–∑–∏—Ü—ñ—ó –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è)

**–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è:** –ó–≤'—è–∑—É—î –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –∑ —Ç–æ–≤–∞—Ä–∞–º–∏

**–ö–ª—é—á–æ–≤—ñ –ø–æ–ª—è:**
- `order_id` (FK ‚Üí orders.order_id)
- `product_id` (FK ‚Üí products.product_id)
- `quantity` - –°–∫—ñ–ª—å–∫–∏ –æ–¥–∏–Ω–∏—Ü—å —Ç–æ–≤–∞—Ä—É –≤ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—ñ

---

### 3Ô∏è‚É£ **PRODUCTS** (–¢–æ–≤–∞—Ä–∏)

**–ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è:** –ó–±–µ—Ä—ñ–≥–∞—î —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ —Ç–æ–≤–∞—Ä–∏ —Ç–∞ –∑–∞–≥–∞–ª—å–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å –Ω–∞ —Å–∫–ª–∞–¥—ñ

**–ö–ª—é—á–æ–≤—ñ –ø–æ–ª—è:**
- `product_id` (PK)
- `sku` - –ê—Ä—Ç–∏–∫—É–ª
- `name` - –ù–∞–∑–≤–∞
- `quantity` - **–ó–ê–ì–ê–õ–¨–ù–ê –ö–Ü–õ–¨–ö–Ü–°–¢–¨ –ù–ê –°–ö–õ–ê–î–Ü**
- `frozen_quantity` - (–ó–∞—Å—Ç–∞—Ä—ñ–ª–µ –ø–æ–ª–µ, –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è)

---

## üîÑ –Ø–∫ –ø—Ä–∞—Ü—é—î —Ä–µ–∑–µ—Ä–≤—É–≤–∞–Ω–Ω—è (–∑–∞–º–æ—Ä–æ–∂—É–≤–∞–Ω–Ω—è)

### –ü—Ä–∏–Ω—Ü–∏–ø —Ä–æ–±–æ—Ç–∏:

```
–î–û–°–¢–£–ü–ù–û = –ó–ê–ì–ê–õ–¨–ù–ê_–ö–Ü–õ–¨–ö–Ü–°–¢–¨ - –ó–ê–†–ï–ó–ï–†–í–û–í–ê–ù–û

–¥–µ:

–ó–ê–ì–ê–õ–¨–ù–ê_–ö–Ü–õ–¨–ö–Ü–°–¢–¨ = products.quantity

–ó–ê–†–ï–ó–ï–†–í–û–í–ê–ù–û = 
  SUM(order_items.quantity) 
  FROM order_items oi
  JOIN orders o ON oi.order_id = o.order_id
  WHERE 
    o.status IN ('processing', 'ready_for_issue', 'issued', 'on_rent')
    AND oi.product_id = :product_id
    AND o.rental_start_date <= :end_date
    AND o.rental_end_date >= :start_date
```

### –ü—Ä–∏–∫–ª–∞–¥:

**–¢–æ–≤–∞—Ä:** –°—Ç–æ–ª–∏–∫ (product_id = 123)
- –ó–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –Ω–∞ —Å–∫–ª–∞–¥—ñ: **10 —à—Ç**

**–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è:**
- –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è #1: 3 —à—Ç, 24-25.11.2025, status = 'issued' ‚úÖ
- –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è #2: 2 —à—Ç, 25-26.11.2025, status = 'processing' ‚úÖ
- –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è #3: 1 —à—Ç, 26-27.11.2025, status = 'returned' ‚ùå

**–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ –Ω–∞ 25.11.2025:**
```
–î–û–°–¢–£–ü–ù–û = 10 - (3 + 2) = 5 —à—Ç
```

–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è #3 –Ω–µ –≤—Ä–∞—Ö–æ–≤—É—î—Ç—å—Å—è, –±–æ —Å—Ç–∞—Ç—É—Å 'returned'

---

## üîç –§–∞–π–ª –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ

**–†–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è:** `/app/backend/utils/availability_checker.py`

### –§—É–Ω–∫—Ü—ñ—è `check_product_availability()`

**–ü–∞—Ä–∞–º–µ—Ç—Ä–∏:**
- `product_id` - ID —Ç–æ–≤–∞—Ä—É
- `quantity` - –°–∫—ñ–ª—å–∫–∏ –ø–æ—Ç—Ä—ñ–±–Ω–æ
- `start_date` - –î–∞—Ç–∞ –ø–æ—á–∞—Ç–∫—É
- `end_date` - –î–∞—Ç–∞ –∑–∞–∫—ñ–Ω—á–µ–Ω–Ω—è
- `exclude_order_id` - –í–∏–∫–ª—é—á–∏—Ç–∏ –ø–µ–≤–Ω–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è (–¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è)

**–ü–æ–≤–µ—Ä—Ç–∞—î:**
```json
{
  "product_id": 123,
  "total_quantity": 10,
  "reserved_quantity": 5,
  "available_quantity": 5,
  "requested_quantity": 3,
  "is_available": true
}
```

---

## üìã API Endpoints –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏

### 1. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ —Ç–æ–≤–∞—Ä—ñ–≤

**POST** `/api/orders/check-availability`

**Body:**
```json
{
  "items": [
    {"product_id": 123, "quantity": 3}
  ],
  "start_date": "2025-11-24",
  "end_date": "2025-11-25",
  "exclude_order_id": null
}
```

**Response:**
```json
{
  "all_available": true,
  "items": [
    {
      "product_id": 123,
      "is_available": true,
      "available_quantity": 5,
      "requested_quantity": 3
    }
  ]
}
```

### 2. –û—Ç—Ä–∏–º–∞—Ç–∏ –∫–∞—Ç–∞–ª–æ–≥ –∑ –¥–æ—Å—Ç—É–ø–Ω—ñ—Å—Ç—é

**GET** `/api/catalog`

**–ü–æ–≤–µ—Ä—Ç–∞—î:** –í—Å—ñ —Ç–æ–≤–∞—Ä–∏ –∑ —Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–∏–º–∏:
- `total` - –ó–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å
- `reserved` - –ó–∞—Ä–µ–∑–µ—Ä–≤–æ–≤–∞–Ω–æ
- `in_rent` - –í –æ—Ä–µ–Ω–¥—ñ (—Å—Ç–∞—Ç—É—Å 'on_rent')
- `available` - –î–æ—Å—Ç—É–ø–Ω–æ

---

## ‚ö†Ô∏è –í–∞–∂–ª–∏–≤–æ!

### ‚ùå –ù–ï –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è:

1. **–¢–∞–±–ª–∏—Ü—è `product_reservations`** - –≤–∏–¥–∞–ª–µ–Ω–∞/–Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è
2. **–ü–æ–ª–µ `frozen_quantity`** –≤ —Ç–∞–±–ª–∏—Ü—ñ products - –∑–∞—Å—Ç–∞—Ä—ñ–ª–µ
3. **–û–∫—Ä–µ–º—ñ –∑–∞–ø–∏—Å–∏ —Ä–µ–∑–µ—Ä–≤–∞—Ü—ñ–π** - –Ω–µ —Å—Ç–≤–æ—Ä—é—é—Ç—å—Å—è

### ‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è:

1. **–¢—ñ–ª—å–∫–∏ `orders.status`** - —î–¥–∏–Ω–µ –¥–∂–µ—Ä–µ–ª–æ —ñ—Å—Ç–∏–Ω–∏
2. **–¶–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–∞ –ª–æ–≥—ñ–∫–∞** –≤ `availability_checker.py`
3. **JOIN –∑ orders —Ç–∞ order_items** –¥–ª—è –ø—ñ–¥—Ä–∞—Ö—É–Ω–∫—É —Ä–µ–∑–µ—Ä–≤–∞—Ü—ñ–π

---

## üîß –ú—ñ—Å—Ü—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è

1. **–ü—Ä–∏ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è** - `/api/decor-orders/{order_id}/move-to-preparation`
2. **–í –∫–∞—Ç–∞–ª–æ–∑—ñ** - `/api/catalog` (–ø–æ–∫–∞–∑—É—î –¥–æ—Å—Ç—É–ø–Ω—ñ—Å—Ç—å)
3. **–ü—Ä–∏ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è** - –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è–º
4. **–ù–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥—ñ** - –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è –ø—Ä–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ —Ç–æ–≤–∞—Ä–∏

---

## üéØ –ü–µ—Ä–µ–≤–∞–≥–∏ —Ü—ñ—î—ó –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∏

‚úÖ **–®–≤–∏–¥–∫—ñ—Å—Ç—å:** –û–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω—ñ SQL –∑–∞–ø–∏—Ç–∏ (–≤—ñ–¥ 300+ —Å–µ–∫—É–Ω–¥ –¥–æ <1 —Å–µ–∫—É–Ω–¥–∏)
‚úÖ **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—å:** –û–¥–Ω–µ –¥–∂–µ—Ä–µ–ª–æ —ñ—Å—Ç–∏–Ω–∏ (orders.status)
‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞:** –ù–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É–≤–∞—Ç–∏ –æ–∫—Ä–µ–º—ñ —Ç–∞–±–ª–∏—Ü—ñ
‚úÖ **–ù–∞–¥—ñ–π–Ω—ñ—Å—Ç—å:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ —Ä–æ–∑–º–æ—Ä–æ–∂—É–≤–∞–Ω–Ω—è –ø—Ä–∏ –∑–º—ñ–Ω—ñ —Å—Ç–∞—Ç—É—Å—É

---

## üìù –ü—Ä–∏–∫–ª–∞–¥ SQL –∑–∞–ø–∏—Ç—É

```sql
-- –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω—ñ—Å—Ç—å —Å—Ç–æ–ª–∏–∫–∞ #123 –Ω–∞ 24-25.11.2025
SELECT 
  p.product_id,
  p.quantity as total,
  COALESCE(SUM(oi.quantity), 0) as reserved,
  (p.quantity - COALESCE(SUM(oi.quantity), 0)) as available
FROM products p
LEFT JOIN order_items oi ON p.product_id = oi.product_id
LEFT JOIN orders o ON oi.order_id = o.order_id 
  AND o.status IN ('processing', 'ready_for_issue', 'issued', 'on_rent')
  AND o.rental_start_date <= '2025-11-25'
  AND o.rental_end_date >= '2025-11-24'
WHERE p.product_id = 123
GROUP BY p.product_id;
```

---

## üöÄ –Ø–∫ –¥–æ–¥–∞—Ç–∏ –Ω–æ–≤—É –ø–µ—Ä–µ–≤—ñ—Ä–∫—É

1. –Ü–º–ø–æ—Ä—Ç—É–π —Ñ—É–Ω–∫—Ü—ñ—é:
```python
from utils.availability_checker import check_product_availability
```

2. –í–∏–∫–ª–∏—á —Ñ—É–Ω–∫—Ü—ñ—é:
```python
result = check_product_availability(
    db=db,
    product_id=123,
    quantity=3,
    start_date="2025-11-24",
    end_date="2025-11-25"
)

if not result['is_available']:
    return {"error": "–¢–æ–≤–∞—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π"}
```

---

**–ê–≤—Ç–æ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—ó:** E1 Agent
**–î–∞—Ç–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è:** 24.11.2025
**–í–µ—Ä—Å—ñ—è —Å–∏—Å—Ç–µ–º–∏:** v3.0 (–∑ –æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–∏–º —Ä–µ–∑–µ—Ä–≤—É–≤–∞–Ω–Ω—è–º)
