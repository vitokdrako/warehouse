{% extends '_base.html' %}
{% block title %}–ê–∫—Ç –ø—Ä–∏–π–º–∞–Ω–Ω—è {{ order.order_number }}{% endblock %}
{% block extra_styles %}
<style>
    .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
    .info-box { background: #f8f9fa; border-radius: 8px; padding: 12px; }
    .info-box .label { font-size: 9pt; color: #666; margin-bottom: 4px; }
    .info-box .value { font-weight: bold; font-size: 11pt; }
    .status-ok { color: #388e3c; background: #e8f5e9; padding: 2px 8px; border-radius: 4px; }
    .status-damage { color: #d32f2f; background: #ffebee; padding: 2px 8px; border-radius: 4px; }
    .status-pending { color: #f57c00; background: #fff3e0; padding: 2px 8px; border-radius: 4px; }
    .location-badge { background: #e3f2fd; color: #1565c0; padding: 2px 8px; border-radius: 4px; font-size: 9pt; }
    .receivers-box { background: #e8f5e9; border: 1px solid #a5d6a7; border-radius: 8px; padding: 12px; margin-bottom: 15px; }
    .fees-box { background: #fff3e0; border: 1px solid #ffcc80; border-radius: 8px; padding: 12px; margin-top: 15px; }
    .damage-note { background: #ffebee; border-left: 3px solid #f44336; padding: 8px 12px; margin-top: 5px; font-size: 9pt; }
</style>
{% endblock %}
{% block content %}
<div class="header">
    <div>
        <div class="logo">FarforRent</div>
        <div class="logo-sub">–û—Ä–µ–Ω–¥–∞ –¥–µ–∫–æ—Ä—É</div>
    </div>
    <div class="doc-info">
        <div class="doc-number">{{ doc_number }}</div>
        <div class="doc-date">{{ generated_at }}</div>
    </div>
</div>

<h1>–ê–ö–¢ –ü–†–ò–ô–ú–ê–ù–ù–Ø-–ü–û–í–ï–†–ù–ï–ù–ù–Ø</h1>

<div class="info-grid">
    <div class="info-box">
        <div class="label">–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è</div>
        <div class="value">{{ order.order_number }}</div>
    </div>
    <div class="info-box">
        <div class="label">–ö–ª—ñ—î–Ω—Ç</div>
        <div class="value">{{ order.customer_name }}</div>
    </div>
    <div class="info-box">
        <div class="label">–ü–µ—Ä—ñ–æ–¥ –æ—Ä–µ–Ω–¥–∏</div>
        <div class="value">{{ order.rental_start_date }} ‚Äî {{ order.rental_end_date }}</div>
    </div>
    <div class="info-box">
        <div class="label">–î–∞—Ç–∞ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è</div>
        <div class="value">{{ generated_at }}</div>
    </div>
</div>

{% if receivers and receivers|length > 0 %}
<div class="receivers-box">
    <div style="font-size: 10pt; color: #2e7d32; margin-bottom: 5px;">üë∑ –ü—Ä–∏–π–Ω—è–ª–∏ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è:</div>
    <div style="font-size: 12pt; font-weight: bold;">
        {% for r in receivers %}
            {{ r.name if r.name else r }}{% if not loop.last %}, {% endif %}
        {% endfor %}
    </div>
</div>
{% endif %}

<h2>–ü—Ä–∏–π–Ω—è—Ç—ñ —Ç–æ–≤–∞—Ä–∏</h2>
<table>
    <thead>
        <tr>
            <th style="width:30px">‚Ññ</th>
            <th>–ù–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—è</th>
            <th style="width:70px">SKU</th>
            <th style="width:70px">–õ–æ–∫–∞—Ü—ñ—è</th>
            <th style="width:50px">–ó–¥–∞–Ω–æ</th>
            <th style="width:50px">–ü—Ä–∏–π–Ω.</th>
            <th style="width:100px">–°—Ç–∞–Ω</th>
        </tr>
    </thead>
    <tbody>
        {% for item in items %}
        {% set findings = item.get('findings', []) %}
        {% set returned = item.get('returned_qty') or item.get('rented_qty') or item.get('qty', 1) %}
        {% set rented = item.get('rented_qty') or item.get('qty', 1) %}
        <tr>
            <td class="text-center">{{ loop.index }}</td>
            <td>{{ item.get('name', '') }}</td>
            <td>{{ item.get('sku', '') }}</td>
            <td><span class="location-badge">{{ item.get('location') or item.get('location_zone') or 'N/A' }}</span></td>
            <td class="text-center">{{ rented }}</td>
            <td class="text-center">{{ returned }}</td>
            <td>
                {% if findings and findings|length > 0 %}
                    <span class="status-damage">‚ö†Ô∏è –ü–æ—à–∫–æ–¥–∂–µ–Ω–æ</span>
                {% elif returned >= rented %}
                    <span class="status-ok">‚úì OK</span>
                {% else %}
                    <span class="status-pending">‚è≥ –ß–∞—Å—Ç–∫–æ–≤–æ</span>
                {% endif %}
            </td>
        </tr>
        {% if findings and findings|length > 0 %}
        <tr>
            <td colspan="7" style="padding: 0 0 10px 40px;">
                <div class="damage-note">
                    <strong>–í–∏—è–≤–ª–µ–Ω—ñ –ø–æ—à–∫–æ–¥–∂–µ–Ω–Ω—è:</strong>
                    {% for f in findings %}
                        {{ f.get('category', '') }} - {{ f.get('kind', f.get('damage_type', '–¥–µ—Ñ–µ–∫—Ç')) }}
                        {% if f.get('fee') %} (‚Ç¥{{ f.fee }}){% endif %}{% if not loop.last %}; {% endif %}
                    {% endfor %}
                </div>
            </td>
        </tr>
        {% endif %}
        {% endfor %}
    </tbody>
</table>

<div style="margin-top:15px; padding:10px; background:#f5f5f5; border-radius:8px;">
    {% set total_returned = namespace(value=0) %}
    {% set total_rented = namespace(value=0) %}
    {% set items_with_damage = namespace(count=0) %}
    {% for item in items %}
        {% set total_returned.value = total_returned.value + (item.get('returned_qty') or item.get('rented_qty') or item.get('qty', 1)) %}
        {% set total_rented.value = total_rented.value + (item.get('rented_qty') or item.get('qty', 1)) %}
        {% if item.get('findings') and item.get('findings')|length > 0 %}
            {% set items_with_damage.count = items_with_damage.count + 1 %}
        {% endif %}
    {% endfor %}
    <strong>–í—Å—å–æ–≥–æ –ø–æ–∑–∏—Ü—ñ–π:</strong> {{ items|length }} | 
    <strong>–ü—Ä–∏–π–Ω—è—Ç–æ:</strong> {{ total_returned.value }}/{{ total_rented.value }} –æ–¥. |
    <strong>–ó –ø–æ—à–∫–æ–¥–∂–µ–Ω–Ω—è–º–∏:</strong> {{ items_with_damage.count }}
</div>

{% if fees and (fees.damage_fee or fees.cleaning_fee or fees.late_fee) %}
<div class="fees-box">
    <div style="font-size: 10pt; color: #e65100; margin-bottom: 8px; font-weight: bold;">üí∞ –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω—ñ –Ω–∞—Ä–∞—Ö—É–≤–∞–Ω–Ω—è:</div>
    <table style="width:100%; font-size:10pt;">
        {% if fees.damage_fee %}
        <tr><td>–ü–æ—à–∫–æ–¥–∂–µ–Ω–Ω—è:</td><td class="text-right" style="white-space:nowrap"><strong>{{ "%.2f"|format(fees.damage_fee) }} ‚Ç¥</strong></td></tr>
        {% endif %}
        {% if fees.cleaning_fee %}
        <tr><td>–ß–∏—Å—Ç–∫–∞:</td><td class="text-right" style="white-space:nowrap"><strong>{{ "%.2f"|format(fees.cleaning_fee) }} ‚Ç¥</strong></td></tr>
        {% endif %}
        {% if fees.late_fee %}
        <tr><td>–ü—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω–Ω—è:</td><td class="text-right" style="white-space:nowrap"><strong>{{ "%.2f"|format(fees.late_fee) }} ‚Ç¥</strong></td></tr>
        {% endif %}
        <tr style="border-top: 1px solid #ffcc80; font-size: 11pt;">
            <td><strong>–†–ê–ó–û–ú –¥–æ —É—Ç—Ä–∏–º–∞–Ω–Ω—è:</strong></td>
            <td class="text-right" style="white-space:nowrap"><strong>{{ "%.2f"|format((fees.damage_fee or 0) + (fees.cleaning_fee or 0) + (fees.late_fee or 0)) }} ‚Ç¥</strong></td>
        </tr>
    </table>
</div>
{% endif %}

<div class="highlight" style="padding:10px; margin-top:20px;">
    <p class="font-bold">üìã –£–º–æ–≤–∏:</p>
    <p class="text-sm">–ü—ñ–¥–ø–∏—Å—É—é—á–∏ —Ü–µ–π –∞–∫—Ç, –∫–ª—ñ—î–Ω—Ç –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂—É—î –ø–µ—Ä–µ–¥–∞—á—É —Ç–æ–≤–∞—Ä—ñ–≤ –Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É. –§—ñ–Ω–∞–ª—å–Ω–∏–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –∑–∞—Å—Ç–∞–≤–∏ –±—É–¥–µ –ø—Ä–æ–≤–µ–¥–µ–Ω–æ –ø—Ä–æ—Ç—è–≥–æ–º 24 –≥–æ–¥–∏–Ω –ø—ñ—Å–ª—è –æ–≥–ª—è–¥—É.</p>
</div>

<div class="signatures">
    <div class="signature-block">
        <p class="font-bold">–ü–†–ò–ô–ù–Ø–í (–û—Ä–µ–Ω–¥–æ–¥–∞–≤–µ—Ü—å):</p>
        <div class="signature-line"></div>
        <div class="signature-label">–ø—ñ–¥–ø–∏—Å / –ü–Ü–ë</div>
    </div>
    <div class="signature-block">
        <p class="font-bold">–ü–ï–†–ï–î–ê–í (–û—Ä–µ–Ω–¥–∞—Ä):</p>
        <p class="text-sm">{{ order.customer_name }}</p>
        <div class="signature-line"></div>
        <div class="signature-label">–ø—ñ–¥–ø–∏—Å</div>
    </div>
</div>
{% endblock %}