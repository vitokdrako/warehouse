# ğŸ’¼ Ğ¤Ñ–Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ğ¸Ğ¹ ĞšĞ°Ğ±Ñ–Ğ½ĞµÑ‚ (FinanceHub) - ĞŸĞ¾Ğ²Ğ½Ğ¸Ğ¹ Ğ’Ğ¾Ñ€ĞºÑ„Ğ»Ğ¾Ñƒ v2.0

## ğŸ“Œ ĞĞ³Ğ»ÑĞ´

**Ğ¤Ñ–Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ğ¸Ğ¹ ĞºĞ°Ğ±Ñ–Ğ½ĞµÑ‚** â€” Ñ†Ğµ Ñ†ĞµĞ½Ñ‚Ñ€Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¹ Ñ–Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚ Ğ´Ğ»Ñ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»Ñ–Ğ½Ğ½Ñ Ñ„Ñ–Ğ½Ğ°Ğ½ÑĞ°Ğ¼Ğ¸ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ñ–Ñ— Ğ· Ğ¿Ñ€Ğ¾ĞºĞ°Ñ‚Ñƒ Ğ´ĞµĞºĞ¾Ñ€Ñƒ. Ğ Ğ¾Ğ·Ñ‚Ğ°ÑˆĞ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹ Ñƒ Ñ„Ğ°Ğ¹Ğ»Ñ– `/frontend/src/pages/FinanceHub.jsx` Ñ‚Ğ° Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ” Ğ±ĞµĞºĞµĞ½Ğ´ `/backend/routes/finance.py`.

**URL:** `https://rentalhub.farforrent.com.ua/finance`

---

## ğŸ¯ 1. Ğ”Ğ¶ĞµÑ€ĞµĞ»Ğ¾ Ğ¿Ñ€Ğ°Ğ²Ğ´Ğ¸ (Source of Truth)

### ĞšĞ»ÑÑ‡Ğ¾Ğ²Ğ¸Ğ¹ Ğ¿Ñ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Ğ”Ğ–Ğ•Ğ Ğ•Ğ›Ğ ĞŸĞ ĞĞ’Ğ”Ğ˜                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  payer_profiles          = SOURCE OF TRUTH Ğ´Ğ»Ñ Ñ€ĞµĞºĞ²Ñ–Ğ·Ğ¸Ñ‚Ñ–Ğ²               â”‚
â”‚  (Ğ¶Ğ¸Ğ²Ñ– Ğ´Ğ°Ğ½Ñ–)               Ğ¢ÑƒÑ‚ Ñ€ĞµĞ´Ğ°Ğ³ÑƒÑÑ‚ÑŒÑÑ, Ñ‚ÑƒÑ‚ Ğ°ĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ñ–               â”‚
â”‚                                                                         â”‚
â”‚  orders.payer_snapshot_json = "Ğ—ĞĞœĞĞ ĞĞ–Ğ•ĞĞ ĞšĞĞŸĞ†Ğ¯" Ğ½Ğ° Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚ Ğ¾Ñ€Ğ´ĞµÑ€Ğ°       â”‚
â”‚  (Ğ°Ñ€Ñ…Ñ–Ğ²Ğ½Ğ° ĞºĞ¾Ğ¿Ñ–Ñ)            Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¸ Ğ±ĞµÑ€ÑƒÑ‚ÑŒ Ğ´Ğ°Ğ½Ñ– Ğ—Ğ’Ğ†Ğ”Ğ¡Ğ˜                â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Ğ§Ğ¾Ğ¼Ñƒ Ñ†Ğµ Ğ²Ğ°Ğ¶Ğ»Ğ¸Ğ²Ğ¾:

```
Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ñ–Ğ¹: ĞšĞ»Ñ–Ñ”Ğ½Ñ‚ Ğ·Ğ¼Ñ–Ğ½Ğ¸Ğ² IBAN Ğ¿Ñ–ÑĞ»Ñ Ğ¿Ñ–Ğ´Ğ¿Ğ¸ÑĞ°Ğ½Ğ½Ñ Ğ´Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€Ñƒ

âŒ ĞĞ•ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ¬ĞĞ: Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¸ Ğ±ĞµÑ€ÑƒÑ‚ÑŒ Ğ´Ğ°Ğ½Ñ– Ğ· payer_profiles
   â†’ Ğ¡Ñ‚Ğ°Ñ€Ğ¸Ğ¹ Ğ´Ğ¾Ğ³Ğ¾Ğ²Ñ–Ñ€ Ğ¿Ğ¾ĞºĞ°Ğ·ÑƒÑ” Ğ½Ğ¾Ğ²Ğ¸Ğ¹ IBAN = ÑÑ€Ğ¸Ğ´Ğ¸Ñ‡Ğ½Ğ° Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°

âœ… ĞŸĞ ĞĞ’Ğ˜Ğ›Ğ¬ĞĞ: Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¸ Ğ±ĞµÑ€ÑƒÑ‚ÑŒ Ğ´Ğ°Ğ½Ñ– Ğ· payer_snapshot_json
   â†’ Ğ¡Ñ‚Ğ°Ñ€Ğ¸Ğ¹ Ğ´Ğ¾Ğ³Ğ¾Ğ²Ñ–Ñ€ Ğ¿Ğ¾ĞºĞ°Ğ·ÑƒÑ” IBAN ÑĞºĞ¸Ğ¹ Ğ±ÑƒĞ² Ğ½Ğ° Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚ Ğ¿Ñ–Ğ´Ğ¿Ğ¸ÑÑƒ
   â†’ ĞĞ¾Ğ²Ğ¸Ğ¹ Ğ´Ğ¾Ğ³Ğ¾Ğ²Ñ–Ñ€ Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ°Ñ” Ğ½Ğ¾Ğ²Ğ¸Ğ¹ IBAN (Ğ½Ğ¾Ğ²Ğ¸Ğ¹ snapshot)
```

### ĞœĞ¾Ğ¼ĞµĞ½Ñ‚ ÑÑ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ snapshot:

```
POST /api/orders/{order_id}/assign-payer
  body: { payer_profile_id: 5 }

Backend Ñ€Ğ¾Ğ±Ğ¸Ñ‚ÑŒ:
  1. Ğ§Ğ¸Ñ‚Ğ°Ñ” payer_profiles WHERE id = 5
  2. Ğ¡ĞµÑ€Ñ–Ğ°Ğ»Ñ–Ğ·ÑƒÑ” Ğ² JSON
  3. Ğ—Ğ°Ğ¿Ğ¸ÑÑƒÑ” Ğ² orders.payer_snapshot_json
  4. Ğ—Ğ°Ğ¿Ğ¸ÑÑƒÑ” orders.payer_profile_id = 5
```

---

## ğŸ“œ 2. ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ° Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ–Ğ²: MA â†’ Annex

### ĞšĞ»ÑÑ‡Ğ¾Ğ²Ğ¸Ğ¹ Ğ¿Ñ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           MASTER AGREEMENT = Ğ”ĞĞ“ĞĞ’Ğ†Ğ  ĞŸĞ›ĞĞ¢ĞĞ˜ĞšĞ, ĞĞ• ĞĞ Ğ”Ğ•Ğ Ğ               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  Master Agreement (MA)                                                  â”‚
â”‚  â”œâ”€â”€ ĞŸÑ€Ğ¸Ğ²'ÑĞ·Ğ°Ğ½Ğ¸Ğ¹ Ğ´Ğ¾: payer_profile_id                                   â”‚
â”‚  â”œâ”€â”€ Ğ¢ĞµÑ€Ğ¼Ñ–Ğ½ Ğ´Ñ–Ñ—: 12 Ğ¼Ñ–ÑÑÑ†Ñ–Ğ²                                             â”‚
â”‚  â”œâ”€â”€ Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ: draft â†’ active â†’ signed â†’ expired                          â”‚
â”‚  â””â”€â”€ ĞĞ´Ğ¸Ğ½ MA = Ğ±Ğ°Ğ³Ğ°Ñ‚Ğ¾ Annexes Ğ²Ñ–Ğ´ Ñ€Ñ–Ğ·Ğ½Ğ¸Ñ… Ğ¾Ñ€Ğ´ĞµÑ€Ñ–Ğ²                        â”‚
â”‚                                                                         â”‚
â”‚  Annex (Ğ”Ğ¾Ğ´Ğ°Ñ‚Ğ¾Ğº)                                                        â”‚
â”‚  â”œâ”€â”€ ĞŸÑ€Ğ¸Ğ²'ÑĞ·Ğ°Ğ½Ğ¸Ğ¹ Ğ´Ğ¾: order_id + master_agreement_id                     â”‚
â”‚  â”œâ”€â”€ ĞœÑ–ÑÑ‚Ğ¸Ñ‚ÑŒ: Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ñ–Ñ—, Ğ´Ğ°Ñ‚Ğ¸, ÑÑƒĞ¼Ğ¸, Ğ´ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ñ€Ğ´ĞµÑ€Ğ°           â”‚
â”‚  â””â”€â”€ ĞŸĞ¾ÑĞ¸Ğ»Ğ°Ñ”Ñ‚ÑŒÑÑ Ğ½Ğ° MA ÑĞº Ğ½Ğ° "Ñ€Ğ°Ğ¼ĞºĞ¾Ğ²Ğ¸Ğ¹ Ğ´Ğ¾Ğ³Ğ¾Ğ²Ñ–Ñ€"                         â”‚
â”‚                                                                         â”‚
â”‚  Issue/Return/Defect Acts                                               â”‚
â”‚  â””â”€â”€ Ğ—Ğ°Ğ²Ğ¶Ğ´Ğ¸ Ğ¿Ñ€Ğ¸Ğ²'ÑĞ·Ğ°Ğ½Ñ– Ğ´Ğ¾: order_id                                     â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†ÑŒ:

```sql
-- Master Agreement = Ğ´Ğ¾Ğ³Ğ¾Ğ²Ñ–Ñ€ Ğ· Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¸ĞºĞ¾Ğ¼
CREATE TABLE master_agreements (
    id INT PRIMARY KEY AUTO_INCREMENT,
    payer_profile_id INT NOT NULL,      -- â† ĞšĞ»ÑÑ‡Ğ¾Ğ²Ğ¸Ğ¹ Ğ·Ğ²'ÑĞ·Ğ¾Ğº!
    agreement_number VARCHAR(50),
    valid_from DATE,
    valid_to DATE,                       -- +12 Ğ¼Ñ–Ñ Ğ²Ñ–Ğ´ valid_from
    status ENUM('draft','active','signed','expired'),
    pdf_path VARCHAR(255),
    signed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    FOREIGN KEY (payer_profile_id) REFERENCES payer_profiles(id)
);

-- Annex = Ğ´Ğ¾Ğ´Ğ°Ñ‚Ğ¾Ğº Ğ´Ğ¾ Ğ¾Ñ€Ğ´ĞµÑ€Ğ°, Ğ¿Ğ¾ÑĞ¸Ğ»Ğ°Ñ”Ñ‚ÑŒÑÑ Ğ½Ğ° MA
CREATE TABLE order_annexes (
    id INT PRIMARY KEY AUTO_INCREMENT,
    order_id INT NOT NULL,               -- â† ĞšĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¸Ğ¹ Ğ¾Ñ€Ğ´ĞµÑ€
    master_agreement_id INT NOT NULL,    -- â† ĞŸĞ¾ÑĞ¸Ğ»Ğ°Ğ½Ğ½Ñ Ğ½Ğ° MA
    annex_number VARCHAR(50),
    version INT DEFAULT 1,
    status ENUM('draft','sent','signed'),
    pdf_path VARCHAR(255),
    created_at TIMESTAMP DEFAULT NOW(),
    FOREIGN KEY (order_id) REFERENCES orders(order_id),
    FOREIGN KEY (master_agreement_id) REFERENCES master_agreements(id)
);

-- Orders Ğ¼Ğ°Ñ” ÑˆĞ²Ğ¸Ğ´ĞºĞµ Ğ¿Ğ¾ÑĞ¸Ğ»Ğ°Ğ½Ğ½Ñ Ğ½Ğ° Ğ°ĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¸Ğ¹ annex
ALTER TABLE orders ADD COLUMN active_annex_id INT;
```

### Ğ’Ñ–Ğ·ÑƒĞ°Ğ»Ñ–Ğ·Ğ°Ñ†Ñ–Ñ Ğ·Ğ²'ÑĞ·ĞºÑ–Ğ²:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ payer_profiles  â”‚
â”‚ (id: 5)         â”‚
â”‚ Ğ¢ĞĞ’ "Ğ”ĞµĞºĞ¾Ñ€"     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ payer_profile_id = 5
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        master_agreements            â”‚
â”‚        (id: 10)                     â”‚
â”‚        Ğ”Ğ¾Ğ³Ğ¾Ğ²Ñ–Ñ€ â„–MA-2024-010         â”‚
â”‚        valid_to: 2025-02-13         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                   â”‚
         â”‚ master_agreement_id = 10
         â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  order_annexes  â”‚  â”‚  order_annexes  â”‚
â”‚  order_id: 7329 â”‚  â”‚  order_id: 7445 â”‚
â”‚  Ğ”Ğ¾Ğ´Ğ°Ñ‚Ğ¾Ğº â„–1     â”‚  â”‚  Ğ”Ğ¾Ğ´Ğ°Ñ‚Ğ¾Ğº â„–2     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ 3. ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ° Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ñ–Ñ— Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ–Ğ² (Policy Matrix)

### ĞŸĞ¾ Ñ‚Ğ¸Ğ¿Ñƒ Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¸ĞºĞ°:

| Ğ¢Ğ¸Ğ¿ Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¸ĞºĞ° | quote | invoice_offer | MA | Annex | Service Act |
|--------------|-------|---------------|-----|-------|-------------|
| `individual` | âœ… | âœ… | âš ï¸* | âš ï¸* | âš ï¸* |
| `fop` | âœ… | âœ… | âœ… | âœ… | âœ… |
| `company` | âœ… | âœ… | âœ… | âœ… | âœ… |
| `foreign` | âœ… | âŒ | âŒ | âŒ | âŒ |
| `pending` | âœ… | âŒ | âŒ | âŒ | âŒ |

*âš ï¸ = Ğ¼Ğ¾Ğ¶Ğ½Ğ° Ğ´Ğ¾Ğ·Ğ²Ğ¾Ğ»Ğ¸Ñ‚Ğ¸ Ğ´Ğ»Ñ individual ÑĞºÑ‰Ğ¾ Ñ” Ğ¿Ğ°ÑĞ¿Ğ¾Ñ€Ñ‚/Ğ°Ğ´Ñ€ĞµÑĞ°, Ğ°Ğ±Ğ¾ Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ°Ñ‚Ğ¸ ÑĞ¿Ñ€Ğ¾Ñ‰ĞµĞ½Ğ¸Ğ¹ ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½ MA*

### ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼ Ğ¿ĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ¸ Ğ² ĞºĞ¾Ğ´Ñ–:

```python
def can_generate_document(order, doc_type):
    # ĞšÑ€Ğ¾Ğº 1: Ğ§Ğ¸ Ñ” Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¸Ğº?
    if not order.payer_profile_id:
        if doc_type in ['quote']:
            return True  # quote Ğ¼Ğ¾Ğ¶Ğ½Ğ° Ğ±ĞµĞ· Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¸ĞºĞ°
        return False
    
    # ĞšÑ€Ğ¾Ğº 2: ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ñ‚Ğ¸Ğ¿ Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¸ĞºĞ°
    payer = get_payer_profile(order.payer_profile_id)
    
    # ĞšÑ€Ğ¾Ğº 3: Policy matrix
    POLICY = {
        'individual': ['quote', 'invoice_offer', 'ma', 'annex', 'service_act'],
        'fop': ['quote', 'invoice_offer', 'ma', 'annex', 'service_act'],
        'company': ['quote', 'invoice_offer', 'ma', 'annex', 'service_act'],
        'foreign': ['quote'],
        'pending': ['quote']
    }
    
    return doc_type in POLICY.get(payer.type, [])
```

---

## ğŸ”„ 4. ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡Ğ½Ğµ Ğ¿Ñ–Ğ´Ñ‚ÑĞ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¸ĞºĞ° Ğ¿Ñ€Ğ¸ ÑÑ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ– Ğ¾Ñ€Ğ´ĞµÑ€Ğ°

### Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ñ–Ğ¹ A: ĞšĞ»Ñ–Ñ”Ğ½Ñ‚ Ğ²Ğ¶Ğµ Ñ–ÑĞ½ÑƒÑ” (email Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¸Ğ¹)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EventTool â†’ POST /api/event/boards/{id}/convert-to-order             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚ 1. ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ email Ğ· Ñ„Ğ¾Ñ€Ğ¼Ğ¸ (vitokdrako@gmail.com)                    â”‚
â”‚                                                                      â”‚
â”‚ 2. ĞĞ¾Ñ€Ğ¼Ğ°Ğ»Ñ–Ğ·ÑƒÑ”Ğ¼Ğ¾ email: lower(), trim()                               â”‚
â”‚                                                                      â”‚
â”‚ 3. Ğ¨ÑƒĞºĞ°Ñ”Ğ¼Ğ¾ client_user:                                              â”‚
â”‚    SELECT * FROM client_users                                        â”‚
â”‚    WHERE email_normalized = 'vitokdrako@gmail.com'                   â”‚
â”‚                                                                      â”‚
â”‚ 4. Ğ—ĞĞĞ™Ğ”Ğ•ĞĞ â†’ client_user_id = 54                                    â”‚
â”‚                                                                      â”‚
â”‚ 5. Ğ’Ğ¸Ğ·Ğ½Ğ°Ñ‡Ğ°Ñ”Ğ¼Ğ¾ Ğ´ĞµÑ„Ğ¾Ğ»Ñ‚Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¸ĞºĞ°:                                   â”‚
â”‚                                                                      â”‚
â”‚    SELECT p.* FROM payer_profiles p                                  â”‚
â”‚    JOIN client_payer_links l ON l.payer_profile_id = p.id            â”‚
â”‚    WHERE l.client_user_id = 54                                       â”‚
â”‚    ORDER BY l.is_default DESC, l.created_at ASC                      â”‚
â”‚    LIMIT 1                                                           â”‚
â”‚                                                                      â”‚
â”‚    Ğ’Ğ°Ñ€Ñ–Ğ°Ğ½Ñ‚Ğ¸:                                                         â”‚
â”‚    â”œâ”€â”€ is_default = 1 â†’ Ğ±ĞµÑ€ĞµĞ¼Ğ¾ Ğ¹Ğ¾Ğ³Ğ¾                                  â”‚
â”‚    â”œâ”€â”€ Ñ€Ñ–Ğ²Ğ½Ğ¾ 1 Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¸Ğº â†’ Ğ±ĞµÑ€ĞµĞ¼Ğ¾ Ğ¹Ğ¾Ğ³Ğ¾                                 â”‚
â”‚    â””â”€â”€ 0 Ğ°Ğ±Ğ¾ >1 Ğ±ĞµĞ· Ğ´ĞµÑ„Ğ¾Ğ»Ñ‚Ñƒ â†’ payer_profile_id = NULL                â”‚
â”‚                                                                      â”‚
â”‚ 6. Ğ¡Ñ‚Ğ²Ğ¾Ñ€ÑÑ”Ğ¼Ğ¾ Ğ¾Ñ€Ğ´ĞµÑ€:                                                  â”‚
â”‚    INSERT INTO orders (                                              â”‚
â”‚      client_user_id,                                                 â”‚
â”‚      payer_profile_id,                                               â”‚
â”‚      payer_snapshot_json,  -- ÑĞºÑ‰Ğ¾ Ñ” Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¸Ğº                         â”‚
â”‚      ...                                                             â”‚
â”‚    )                                                                 â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ñ–Ğ¹ B: ĞšĞ»Ñ–Ñ”Ğ½Ñ‚ Ğ½Ğ¾Ğ²Ğ¸Ğ¹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ĞĞ¾Ğ²Ğ¸Ğ¹ ĞºĞ»Ñ–Ñ”Ğ½Ñ‚ (email Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾)                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚ 1. Ğ¡Ñ‚Ğ²Ğ¾Ñ€ÑÑ”Ğ¼Ğ¾ client_user:                                            â”‚
â”‚    INSERT INTO client_users (                                        â”‚
â”‚      email, email_normalized, full_name, phone, source               â”‚
â”‚    ) VALUES (                                                        â”‚
â”‚      'new@email.com', 'new@email.com', 'Ğ†Ğ¼'Ñ', '+380...', 'eventtool'â”‚
â”‚    )                                                                 â”‚
â”‚    â†’ client_user_id = 56                                             â”‚
â”‚                                                                      â”‚
â”‚ 2. Ğ¡Ñ‚Ğ²Ğ¾Ñ€ÑÑ”Ğ¼Ğ¾ "Ñ‡ĞµÑ€Ğ½ĞµÑ‚ĞºÑƒ Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¸ĞºĞ°":                                    â”‚
â”‚    INSERT INTO payer_profiles (                                      â”‚
â”‚      type, display_name, tax_mode                                    â”‚
â”‚    ) VALUES (                                                        â”‚
â”‚      'individual',  -- Ğ°Ğ±Ğ¾ 'pending'                                 â”‚
â”‚      'Ğ†Ğ¼'Ñ ĞºĞ»Ñ–Ñ”Ğ½Ñ‚Ğ°',                                                 â”‚
â”‚      'none'                                                          â”‚
â”‚    )                                                                 â”‚
â”‚    â†’ payer_profile_id = 7                                            â”‚
â”‚                                                                      â”‚
â”‚ 3. Ğ›Ñ–Ğ½ĞºÑƒÑ”Ğ¼Ğ¾:                                                         â”‚
â”‚    INSERT INTO client_payer_links (                                  â”‚
â”‚      client_user_id, payer_profile_id, is_default                    â”‚
â”‚    ) VALUES (56, 7, TRUE)                                            â”‚
â”‚                                                                      â”‚
â”‚ 4. Ğ¡Ñ‚Ğ²Ğ¾Ñ€ÑÑ”Ğ¼Ğ¾ Ğ¾Ñ€Ğ´ĞµÑ€ Ğ· client_user_id = 56, payer_profile_id = 7       â”‚
â”‚    + payer_snapshot_json                                             â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ‘¤ 5. Ğ Ğ¾Ğ·Ğ´Ñ–Ğ»ĞµĞ½Ğ½Ñ: ĞšĞ»Ñ–Ñ”Ğ½Ñ‚ vs ĞŸĞ»Ğ°Ñ‚Ğ½Ğ¸Ğº

### ĞšĞ»ÑÑ‡Ğ¾Ğ²Ğ¸Ğ¹ Ğ¿Ñ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ĞšĞ›Ğ†Ğ„ĞĞ¢ â‰  ĞŸĞ›ĞĞ¢ĞĞ˜Ğš                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  CLIENT_USER (ĞšĞ»Ñ–Ñ”Ğ½Ñ‚)           PAYER_PROFILE (ĞŸĞ»Ğ°Ñ‚Ğ½Ğ¸Ğº)                 â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•            â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                â”‚
â”‚  â€¢ ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ½Ğ° Ğ¾ÑĞ¾Ğ±Ğ°              â€¢ Ğ®Ñ€Ğ¸Ğ´Ğ¸Ñ‡Ğ½Ñ– Ñ€ĞµĞºĞ²Ñ–Ğ·Ğ¸Ñ‚Ğ¸                    â”‚
â”‚  â€¢ Email, Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½, Ñ–Ğ¼'Ñ         â€¢ Ğ„Ğ”Ğ ĞŸĞĞ£, IBAN, Ğ°Ğ´Ñ€ĞµÑĞ°                  â”‚
â”‚  â€¢ ĞœĞ¾Ğ¶Ğµ Ğ¼Ğ°Ñ‚Ğ¸ Ğ‘ĞĞ“ĞĞ¢Ğ Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¸ĞºÑ–Ğ²   â€¢ ĞœĞ¾Ğ¶Ğµ Ğ±ÑƒÑ‚Ğ¸ Ñƒ Ğ‘ĞĞ“ĞĞ¢Ğ¬ĞĞ¥ ĞºĞ»Ñ–Ñ”Ğ½Ñ‚Ñ–Ğ²         â”‚
â”‚                                                                         â”‚
â”‚  ĞŸÑ€Ğ¸ĞºĞ»Ğ°Ğ´:                                                               â”‚
â”‚  ĞœĞ°Ñ€Ğ¸Ğ½Ğ° ĞŸĞµÑ‚Ñ€ĞµĞ½ĞºĞ¾ (Ğ°Ğ³ĞµĞ½Ñ‚)                                                â”‚
â”‚  â”œâ”€â”€ Ğ¢ĞĞ’ "Ğ”ĞµĞºĞ¾Ñ€ ĞŸĞ»ÑÑ" (Ñ—Ñ— ĞºĞ»Ñ–Ñ”Ğ½Ñ‚ 1)                                     â”‚
â”‚  â”œâ”€â”€ Ğ¤ĞĞŸ Ğ†Ğ²Ğ°Ğ½Ğ¾Ğ² Ğ†.Ğ†. (Ñ—Ñ— ĞºĞ»Ñ–Ñ”Ğ½Ñ‚ 2)                                      â”‚
â”‚  â””â”€â”€ ĞÑĞ¾Ğ±Ğ¸ÑÑ‚Ğ¾ ÑĞº Ñ„Ñ–Ğ·.Ğ¾ÑĞ¾Ğ±Ğ° (Ğ´Ğ»Ñ Ğ²Ğ»Ğ°ÑĞ½Ğ¾Ğ³Ğ¾ Ğ²ĞµÑÑ–Ğ»Ğ»Ñ)                       â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Ğ—Ğ²'ÑĞ·Ğ¾Ğº Ñ‡ĞµÑ€ĞµĞ· link-Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ:

```sql
CREATE TABLE client_payer_links (
    id INT PRIMARY KEY AUTO_INCREMENT,
    client_user_id INT NOT NULL,
    payer_profile_id INT NOT NULL,
    is_default BOOLEAN DEFAULT FALSE,   -- â† ĞĞ´Ğ¸Ğ½ Ğ´ĞµÑ„Ğ¾Ğ»Ñ‚Ğ½Ğ¸Ğ¹ Ğ½Ğ° ĞºĞ»Ñ–Ñ”Ğ½Ñ‚Ğ°
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE KEY (client_user_id, payer_profile_id)
);
```

### Ğ’Ñ–Ğ·ÑƒĞ°Ğ»Ñ–Ğ·Ğ°Ñ†Ñ–Ñ:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                         â”‚
â”‚     client_users                    payer_profiles                      â”‚
â”‚     â•â•â•â•â•â•â•â•â•â•â•â•                    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                    â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚ id: 54       â”‚               â”‚ id: 5               â”‚                 â”‚
â”‚  â”‚ ĞœĞ°Ñ€Ğ¸Ğ½Ğ°       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Ğ¢ĞĞ’ "Ğ”ĞµĞºĞ¾Ñ€ ĞŸĞ»ÑÑ"    â”‚                 â”‚
â”‚  â”‚ ĞŸĞµÑ‚Ñ€ĞµĞ½ĞºĞ¾     â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Ğ„Ğ”Ğ ĞŸĞĞ£: 12345678    â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚         â”‚            â”‚                                                  â”‚
â”‚         â”‚ is_default â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚         â”‚ = TRUE     â”‚          â”‚ id: 6               â”‚                 â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Ğ¤ĞĞŸ Ğ†Ğ²Ğ°Ğ½Ğ¾Ğ² Ğ†.Ğ†.     â”‚                 â”‚
â”‚                      â”‚          â”‚ Ğ„Ğ”Ğ ĞŸĞĞ£: 87654321    â”‚                 â”‚
â”‚                      â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                      â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚ id: 55       â”‚    â”‚          â”‚ id: 7               â”‚                 â”‚
â”‚  â”‚ ĞĞ»ĞµĞ³         â”‚â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Ğ¤ĞĞŸ Ğ†Ğ²Ğ°Ğ½Ğ¾Ğ² Ğ†.Ğ†.     â”‚ â† Ğ¢Ğ¾Ğ¹ ÑĞ°Ğ¼Ğ¸Ğ¹!    â”‚
â”‚  â”‚ ĞšĞ¾Ğ²Ğ°Ğ»ĞµĞ½ĞºĞ¾    â”‚               â”‚ (Ğ±ÑƒÑ…Ğ³Ğ°Ğ»Ñ‚ĞµÑ€ Ğ†Ğ²Ğ°Ğ½Ğ¾Ğ²Ğ°) â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” 6. ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼: "MA Ğ²Ğ¶Ğµ Ñ” Ñ‡Ğ¸ Ñ‚Ñ€ĞµĞ±Ğ° ÑÑ‚Ğ²Ğ¾Ñ€ÑĞ²Ğ°Ñ‚Ğ¸?"

### ĞšĞ¾Ğ»Ğ¸ Ğ¼ĞµĞ½ĞµĞ´Ğ¶ĞµÑ€ Ğ½Ğ°Ñ‚Ğ¸ÑĞºĞ°Ñ” "Master Agreement" Ğ°Ğ±Ğ¾ "Generate Annex":

```python
def get_or_create_ma_for_order(order_id):
    """
    ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼ Ğ²Ğ¸Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ½Ñ MA Ğ´Ğ»Ñ Ğ¾Ñ€Ğ´ĞµÑ€Ğ°
    """
    order = get_order(order_id)
    
    # ĞšÑ€Ğ¾Ğº 1: ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ° Ğ½Ğ°ÑĞ²Ğ½Ğ¾ÑÑ‚Ñ– Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¸ĞºĞ°
    if not order.payer_profile_id:
        return {
            "error": "no_payer",
            "message": "Ğ¡Ğ¿Ğ¾Ñ‡Ğ°Ñ‚ĞºÑƒ Ğ¿Ñ€Ğ¸Ğ²'ÑĞ¶Ñ–Ñ‚ÑŒ Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¸ĞºĞ° Ğ´Ğ¾ Ğ¾Ñ€Ğ´ĞµÑ€Ğ°"
        }
    
    payer_id = order.payer_profile_id
    
    # ĞšÑ€Ğ¾Ğº 2: ĞŸĞ¾ÑˆÑƒĞº Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğ³Ğ¾ MA Ğ´Ğ»Ñ Ñ†ÑŒĞ¾Ğ³Ğ¾ Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¸ĞºĞ°
    active_ma = db.execute("""
        SELECT * FROM master_agreements 
        WHERE payer_profile_id = :payer_id
          AND status IN ('active', 'signed')
          AND valid_to >= CURDATE()
        ORDER BY created_at DESC
        LIMIT 1
    """, {"payer_id": payer_id}).fetchone()
    
    if active_ma:
        # ĞšÑ€Ğ¾Ğº 3a: MA Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾ â†’ Ğ¿Ğ¾Ğ²ĞµÑ€Ñ‚Ğ°Ñ”Ğ¼Ğ¾ Ğ¹Ğ¾Ğ³Ğ¾
        return {
            "ma_exists": True,
            "master_agreement": active_ma,
            "can_create_annex": True
        }
    else:
        # ĞšÑ€Ğ¾Ğº 3b: MA Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾ â†’ Ğ¿Ñ€Ğ¾Ğ¿Ğ¾Ğ½ÑƒÑ”Ğ¼Ğ¾ ÑÑ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚Ğ¸
        return {
            "ma_exists": False,
            "message": "Ğ”Ğ»Ñ Ñ†ÑŒĞ¾Ğ³Ğ¾ Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¸ĞºĞ° Ğ½ĞµĞ¼Ğ°Ñ” Ğ´Ñ–ÑÑ‡Ğ¾Ğ³Ğ¾ Ğ´Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€Ñƒ",
            "action": "create_ma",
            "payer_profile_id": payer_id
        }
```

### UI Flow:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Documents Tab                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  ĞÑ€Ğ´ĞµÑ€ #OC-7329                                                      â”‚
â”‚  ĞŸĞ»Ğ°Ñ‚Ğ½Ğ¸Ğº: Ğ¢ĞĞ’ "Ğ”ĞµĞºĞ¾Ñ€ ĞŸĞ»ÑÑ"                                           â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ“œ Master Agreement                                             â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚ [MA Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾]                                                   â”‚ â”‚
â”‚  â”‚ âœ… Ğ”Ğ¾Ğ³Ğ¾Ğ²Ñ–Ñ€ â„–MA-2024-010                                         â”‚ â”‚
â”‚  â”‚    Ğ”Ñ–Ñ” Ğ´Ğ¾: 13.02.2025                                           â”‚ â”‚
â”‚  â”‚    [ĞŸĞµÑ€ĞµĞ³Ğ»ÑĞ½ÑƒÑ‚Ğ¸ PDF]                                            â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚ [MA Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾]                                                â”‚ â”‚
â”‚  â”‚ âš ï¸ Ğ”Ğ»Ñ Ñ†ÑŒĞ¾Ğ³Ğ¾ Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¸ĞºĞ° Ğ½ĞµĞ¼Ğ°Ñ” Ğ´Ñ–ÑÑ‡Ğ¾Ğ³Ğ¾ Ğ´Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€Ñƒ                    â”‚ â”‚
â”‚  â”‚    [Ğ¡Ñ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚Ğ¸ MA]                                                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ğŸ“ Annexes (Ğ”Ğ¾Ğ´Ğ°Ñ‚ĞºĞ¸)                                            â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚ [Disabled if no MA]                                             â”‚ â”‚
â”‚  â”‚ âš ï¸ Ğ¡Ñ‚Ğ²Ğ¾Ñ€Ñ–Ñ‚ÑŒ ÑĞ¿Ğ¾Ñ‡Ğ°Ñ‚ĞºÑƒ Master Agreement                           â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚ [Enabled if MA exists]                                          â”‚ â”‚
â”‚  â”‚ Ğ”Ğ¾Ğ´Ğ°Ñ‚Ğ¾Ğº â„–1 v3 (signed) - 01.02.2024                             â”‚ â”‚
â”‚  â”‚ [Ğ—Ğ³ĞµĞ½ĞµÑ€ÑƒĞ²Ğ°Ñ‚Ğ¸ Ğ½Ğ¾Ğ²Ğ¸Ğ¹ Annex]                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¨ 7. UX Ğ²Ğ¸Ğ±Ğ¾Ñ€Ñƒ Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¸ĞºĞ° Ğ² Documents Tab

### ĞšĞ¾Ğ»Ğ¸ payer_profile_id Ğ¿ÑƒÑÑ‚Ğ¸Ğ¹:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Documents Tab                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  ĞÑ€Ğ´ĞµÑ€ #OC-7329                                                      â”‚
â”‚  ĞšĞ»Ñ–Ñ”Ğ½Ñ‚: ĞœĞ°Ñ€Ğ¸Ğ½Ğ° ĞŸĞµÑ‚Ñ€ĞµĞ½ĞºĞ¾                                             â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ âš ï¸ ĞŸĞĞ¢Ğ Ğ†Ğ‘Ğ•Ğ ĞŸĞ›ĞĞ¢ĞĞ˜Ğš Ğ”Ğ›Ğ¯ Ğ”ĞĞ“ĞĞ’ĞĞ Ğ†Ğ’                               â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚ Ğ”Ğ»Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ñ–Ñ— Master Agreement Ñ‚Ğ° Annex                         â”‚ â”‚
â”‚  â”‚ Ğ¾Ğ±ĞµÑ€Ñ–Ñ‚ÑŒ Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¸ĞºĞ° Ğ· Ğ¿Ñ€Ğ¾Ñ„Ñ–Ğ»Ñ ĞºĞ»Ñ–Ñ”Ğ½Ñ‚Ğ°                              â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚ â”‚ ĞŸĞ»Ğ°Ñ‚Ğ½Ğ¸ĞºĞ¸ ĞœĞ°Ñ€Ğ¸Ğ½Ğ¸ ĞŸĞµÑ‚Ñ€ĞµĞ½ĞºĞ¾:                                   â”‚ â”‚ â”‚
â”‚  â”‚ â”‚                                                             â”‚ â”‚ â”‚
â”‚  â”‚ â”‚ â—‹ Ğ¢ĞĞ’ "Ğ”ĞµĞºĞ¾Ñ€ ĞŸĞ»ÑÑ" (Ğ„Ğ”Ğ ĞŸĞĞ£: 12345678) â­ Ğ´ĞµÑ„Ğ¾Ğ»Ñ‚             â”‚ â”‚ â”‚
â”‚  â”‚ â”‚ â—‹ Ğ¤ĞĞŸ Ğ†Ğ²Ğ°Ğ½Ğ¾Ğ² Ğ†.Ğ†. (Ğ„Ğ”Ğ ĞŸĞĞ£: 87654321)                        â”‚ â”‚ â”‚
â”‚  â”‚ â”‚ â—‹ Ğ¤Ñ–Ğ·.Ğ¾ÑĞ¾Ğ±Ğ° ĞŸĞµÑ‚Ñ€ĞµĞ½ĞºĞ¾ Ğœ.Ğ’.                                   â”‚ â”‚ â”‚
â”‚  â”‚ â”‚                                                             â”‚ â”‚ â”‚
â”‚  â”‚ â”‚ [+ Ğ¡Ñ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚Ğ¸ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¸ĞºĞ°]                                â”‚ â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚ â˜ Ğ—Ñ€Ğ¾Ğ±Ğ¸Ñ‚Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¸ĞºĞ° Ğ´ĞµÑ„Ğ¾Ğ»Ñ‚Ğ½Ğ¸Ğ¼                          â”‚ â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚ [ĞĞ±Ñ€Ğ°Ñ‚Ğ¸ Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¸ĞºĞ°]                                               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ĞŸÑ€Ğ¸ Ğ½Ğ°Ñ‚Ğ¸ÑĞºĞ°Ğ½Ğ½Ñ– "ĞĞ±Ñ€Ğ°Ñ‚Ğ¸ Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¸ĞºĞ°":

```python
# POST /api/orders/{order_id}/assign-payer
# body: { payer_profile_id: 5, set_as_default: true }

def assign_payer_to_order(order_id, payer_profile_id, set_as_default=False):
    # 1. ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¸ĞºĞ°
    payer = get_payer_profile(payer_profile_id)
    
    # 2. Ğ¡Ñ‚Ğ²Ğ¾Ñ€ÑÑ”Ğ¼Ğ¾ snapshot
    snapshot = {
        "id": payer.id,
        "type": payer.type,
        "display_name": payer.display_name,
        "legal_name": payer.legal_name,
        "edrpou": payer.edrpou,
        "iban": payer.iban,
        "bank_name": payer.bank_name,
        "address": payer.address,
        "signatory_name": payer.signatory_name,
        "signatory_basis": payer.signatory_basis,
        "snapshot_date": datetime.now().isoformat()
    }
    
    # 3. ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ¾Ñ€Ğ´ĞµÑ€
    db.execute("""
        UPDATE orders SET 
            payer_profile_id = :payer_id,
            payer_snapshot_json = :snapshot
        WHERE order_id = :order_id
    """, {
        "order_id": order_id,
        "payer_id": payer_profile_id,
        "snapshot": json.dumps(snapshot)
    })
    
    # 4. ĞĞ¿Ñ†Ñ–Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾: Ğ¾Ğ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ´ĞµÑ„Ğ¾Ğ»Ñ‚
    if set_as_default:
        order = get_order(order_id)
        # Ğ¡ĞºĞ¸Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ¿ĞµÑ€ĞµĞ´Ğ½Ñ–Ğ¹ Ğ´ĞµÑ„Ğ¾Ğ»Ñ‚
        db.execute("""
            UPDATE client_payer_links 
            SET is_default = FALSE 
            WHERE client_user_id = :client_id
        """, {"client_id": order.client_user_id})
        # Ğ¡Ñ‚Ğ°Ğ²Ğ¸Ğ¼Ğ¾ Ğ½Ğ¾Ğ²Ğ¸Ğ¹ Ğ´ĞµÑ„Ğ¾Ğ»Ñ‚
        db.execute("""
            UPDATE client_payer_links 
            SET is_default = TRUE 
            WHERE client_user_id = :client_id 
              AND payer_profile_id = :payer_id
        """, {"client_id": order.client_user_id, "payer_id": payer_profile_id})
    
    db.commit()
    
    return {"success": True, "snapshot_created": True}
```

---

## ğŸ”§ 8. ĞĞµĞ¾Ğ±Ñ…Ñ–Ğ´Ğ½Ñ– Backend Endpoints

### ĞĞ¾Ğ²Ñ–/Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ– endpoints:

```python
# ============================================================
# ASSIGN PAYER TO ORDER (Ğ· snapshot)
# ============================================================

@router.post("/orders/{order_id}/assign-payer")
async def assign_payer_to_order(
    order_id: int,
    data: AssignPayerRequest,  # { payer_profile_id, set_as_default? }
    db: Session = Depends(get_rh_db)
):
    """
    ĞŸÑ€Ğ¸Ğ²'ÑĞ·ÑƒÑ” Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¸ĞºĞ° Ğ´Ğ¾ Ğ¾Ñ€Ğ´ĞµÑ€Ğ° Ñ‚Ğ° ÑÑ‚Ğ²Ğ¾Ñ€ÑÑ” snapshot.
    ĞŸÑ–ÑĞ»Ñ Ñ†ÑŒĞ¾Ğ³Ğ¾ Ğ¼Ğ¾Ğ¶Ğ½Ğ° Ğ³ĞµĞ½ĞµÑ€ÑƒĞ²Ğ°Ñ‚Ğ¸ MA/Annex.
    """
    # 1. Ğ’Ğ°Ğ»Ñ–Ğ´Ğ°Ñ†Ñ–Ñ
    order = get_order(order_id)
    payer = get_payer_profile(data.payer_profile_id)
    
    # 2. Ğ¡Ñ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ snapshot
    snapshot = create_payer_snapshot(payer)
    
    # 3. ĞĞ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ğ¾Ñ€Ğ´ĞµÑ€Ğ°
    update_order_payer(order_id, payer.id, snapshot)
    
    # 4. ĞĞ¿Ñ†Ñ–Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾: set_as_default
    if data.set_as_default:
        set_default_payer(order.client_user_id, payer.id)
    
    return {"success": True, "snapshot": snapshot}


# ============================================================
# GET SUGGESTED PAYER FOR ORDER
# ============================================================

@router.get("/orders/{order_id}/suggested-payer")
async def get_suggested_payer(
    order_id: int,
    db: Session = Depends(get_rh_db)
):
    """
    ĞŸĞ¾Ğ²ĞµÑ€Ñ‚Ğ°Ñ” Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ¾Ğ²Ğ°Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¸ĞºĞ° Ğ´Ğ»Ñ Ğ¾Ñ€Ğ´ĞµÑ€Ğ°
    Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ñ– client_user_id.
    """
    order = get_order(order_id)
    
    if not order.client_user_id:
        return {"candidates": [], "suggested": None}
    
    # ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ Ğ²ÑÑ–Ñ… Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¸ĞºÑ–Ğ² ĞºĞ»Ñ–Ñ”Ğ½Ñ‚Ğ°
    payers = get_client_payers(order.client_user_id)
    
    # Ğ’Ğ¸Ğ·Ğ½Ğ°Ñ‡Ğ°Ñ”Ğ¼Ğ¾ Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ¾Ğ²Ğ°Ğ½Ğ¾Ğ³Ğ¾
    suggested = None
    for p in payers:
        if p.is_default:
            suggested = p
            break
    
    if not suggested and len(payers) == 1:
        suggested = payers[0]
    
    return {
        "candidates": payers,
        "suggested": suggested,
        "client_user_id": order.client_user_id
    }


# ============================================================
# GET/CREATE MA FOR PAYER
# ============================================================

@router.get("/payer-profiles/{payer_id}/master-agreement")
async def get_active_ma(payer_id: int, db: Session = Depends(get_rh_db)):
    """
    ĞŸĞ¾Ğ²ĞµÑ€Ñ‚Ğ°Ñ” Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¸Ğ¹ MA Ğ´Ğ»Ñ Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¸ĞºĞ° Ğ°Ğ±Ğ¾ null.
    """
    ma = db.execute("""
        SELECT * FROM master_agreements 
        WHERE payer_profile_id = :payer_id
          AND status IN ('active', 'signed')
          AND valid_to >= CURDATE()
        ORDER BY created_at DESC
        LIMIT 1
    """, {"payer_id": payer_id}).fetchone()
    
    return {"master_agreement": ma, "exists": ma is not None}


@router.post("/payer-profiles/{payer_id}/master-agreement")
async def create_ma(payer_id: int, db: Session = Depends(get_rh_db)):
    """
    Ğ¡Ñ‚Ğ²Ğ¾Ñ€ÑÑ” Ğ½Ğ¾Ğ²Ğ¸Ğ¹ MA Ğ´Ğ»Ñ Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¸ĞºĞ°.
    Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ” snapshot Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¸ĞºĞ° Ğ½Ğ° Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚ ÑÑ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ.
    """
    payer = get_payer_profile(payer_id)
    
    # Policy check
    if payer.type not in ['fop', 'company', 'individual']:
        raise HTTPException(400, "MA Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¸Ğ¹ Ğ´Ğ»Ñ Ñ†ÑŒĞ¾Ğ³Ğ¾ Ñ‚Ğ¸Ğ¿Ñƒ Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¸ĞºĞ°")
    
    # Ğ¡Ñ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ MA
    ma = create_master_agreement(payer)
    
    return {"master_agreement": ma, "success": True}


# ============================================================
# ANNEX GENERATION (Ğ²Ğ¸Ğ¼Ğ°Ğ³Ğ°Ñ” MA)
# ============================================================

@router.post("/orders/{order_id}/annex")
async def generate_annex(order_id: int, db: Session = Depends(get_rh_db)):
    """
    Ğ“ĞµĞ½ĞµÑ€ÑƒÑ” Annex Ğ´Ğ»Ñ Ğ¾Ñ€Ğ´ĞµÑ€Ğ°.
    Ğ’Ğ¸Ğ¼Ğ°Ğ³Ğ°Ñ”: payer_profile_id + Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¸Ğ¹ MA.
    """
    order = get_order(order_id)
    
    # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ° Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¸ĞºĞ°
    if not order.payer_profile_id:
        raise HTTPException(400, "Ğ¡Ğ¿Ğ¾Ñ‡Ğ°Ñ‚ĞºÑƒ Ğ¿Ñ€Ğ¸Ğ²'ÑĞ¶Ñ–Ñ‚ÑŒ Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¸ĞºĞ°")
    
    # ĞŸĞ¾ÑˆÑƒĞº MA
    ma = get_active_ma_for_payer(order.payer_profile_id)
    if not ma:
        raise HTTPException(400, "Ğ¡Ğ¿Ğ¾Ñ‡Ğ°Ñ‚ĞºÑƒ ÑÑ‚Ğ²Ğ¾Ñ€Ñ–Ñ‚ÑŒ Master Agreement")
    
    # Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ñ–Ñ Annex
    annex = create_annex(order_id, ma.id)
    
    return {"annex": annex, "master_agreement_id": ma.id}
```

---

## âœ¨ 9. ĞšÑ€Ğ°ÑĞ¸Ğ²Ğ¸Ğ¹ Ğ¿Ñ–Ğ´ÑÑƒĞ¼ĞºĞ¾Ğ²Ğ¸Ğ¹ Ğ²Ğ¾Ñ€ĞºÑ„Ğ»Ğ¾Ñƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ĞŸĞĞ’ĞĞ˜Ğ™ Ğ¦Ğ˜ĞšĞ› Ğ ĞĞ‘ĞĞ¢Ğ˜ Ğ— ĞšĞ›Ğ†Ğ„ĞĞ¢ĞĞœ                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  1ï¸âƒ£ ĞšĞ›Ğ†Ğ„ĞĞ¢ Ğ—ĞĞ›Ğ˜Ğ¨ĞĞ„ Ğ—ĞĞ¯Ğ’ĞšĞ£ (EventTool / Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½ / Viber)                  â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â–¼                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° ÑˆÑƒĞºĞ°Ñ” client_user Ğ¿Ğ¾ email                                 â”‚  â”‚
â”‚  â”‚ â”œâ”€â”€ Ğ—Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾ â†’ Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ñ–ÑĞ½ÑƒÑÑ‡Ğ¾Ğ³Ğ¾                            â”‚  â”‚
â”‚  â”‚ â””â”€â”€ ĞĞµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾ â†’ ÑÑ‚Ğ²Ğ¾Ñ€ÑÑ”Ğ¼Ğ¾ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ + Ğ±Ğ°Ğ·Ğ¾Ğ²Ğ¸Ğ¹ payer (individual)    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â–¼                                                                    â”‚
â”‚  2ï¸âƒ£ Ğ¡Ğ¢Ğ’ĞĞ Ğ®Ğ„Ğ¢Ğ¬Ğ¡Ğ¯ ĞĞ Ğ”Ğ•Ğ                                                     â”‚
â”‚     â”‚ â€¢ client_user_id = 54                                              â”‚
â”‚     â”‚ â€¢ payer_profile_id = Ğ´ĞµÑ„Ğ¾Ğ»Ñ‚Ğ½Ğ¸Ğ¹ Ğ°Ğ±Ğ¾ NULL                            â”‚
â”‚     â”‚ â€¢ payer_snapshot_json = snapshot ÑĞºÑ‰Ğ¾ Ñ” Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¸Ğº                    â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â–¼                                                                    â”‚
â”‚  3ï¸âƒ£ ĞœĞ•ĞĞ•Ğ”Ğ–Ğ•Ğ  Ğ’Ğ†Ğ”ĞšĞ Ğ˜Ğ’ĞĞ„ ĞĞ Ğ”Ğ•Ğ  Ğ’ FINANCE HUB                               â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â”œâ”€â”€â–¶ [Ğ¯ĞºÑ‰Ğ¾ payer_profile_id = NULL]                                  â”‚
â”‚     â”‚    â”‚                                                               â”‚
â”‚     â”‚    â–¼                                                               â”‚
â”‚     â”‚    Ğ‘Ğ»Ğ¾Ğº "ĞĞ±ĞµÑ€Ñ–Ñ‚ÑŒ Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¸ĞºĞ°"                                         â”‚
â”‚     â”‚    â€¢ Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¸ĞºÑ–Ğ² ĞºĞ»Ñ–Ñ”Ğ½Ñ‚Ğ°                                      â”‚
â”‚     â”‚    â€¢ ĞšĞ½Ğ¾Ğ¿ĞºĞ° "Ğ¡Ñ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚Ğ¸ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾"                                      â”‚
â”‚     â”‚    â”‚                                                               â”‚
â”‚     â”‚    â–¼                                                               â”‚
â”‚     â”‚    POST /api/orders/{id}/assign-payer                              â”‚
â”‚     â”‚    â†’ payer_snapshot_json ÑÑ‚Ğ²Ğ¾Ñ€ÑÑ”Ñ‚ÑŒÑÑ                               â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â””â”€â”€â–¶ [Ğ¯ĞºÑ‰Ğ¾ payer_profile_id Ñ”]                                       â”‚
â”‚          â”‚                                                               â”‚
â”‚          â–¼                                                               â”‚
â”‚  4ï¸âƒ£ DOCUMENTS TAB                                                        â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â”œâ”€â”€â–¶ ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ° Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾Ğ³Ğ¾ MA Ğ´Ğ»Ñ payer_profile_id                     â”‚
â”‚     â”‚    â”‚                                                               â”‚
â”‚     â”‚    â”œâ”€â”€ MA Ñ” â†’ ĞšĞ½Ğ¾Ğ¿ĞºĞ° "Ğ—Ğ³ĞµĞ½ĞµÑ€ÑƒĞ²Ğ°Ñ‚Ğ¸ Annex"                           â”‚
â”‚     â”‚    â”‚                                                               â”‚
â”‚     â”‚    â””â”€â”€ MA Ğ½ĞµĞ¼Ğ°Ñ” â†’ ĞšĞ½Ğ¾Ğ¿ĞºĞ° "Ğ¡Ñ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚Ğ¸ MA"                             â”‚
â”‚     â”‚                   â”‚                                                â”‚
â”‚     â”‚                   â–¼                                                â”‚
â”‚     â”‚                   POST /api/payer-profiles/{id}/master-agreement   â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â–¼                                                                    â”‚
â”‚  5ï¸âƒ£ Ğ“Ğ•ĞĞ•Ğ ĞĞ¦Ğ†Ğ¯ Ğ”ĞĞšĞ£ĞœĞ•ĞĞ¢Ğ†Ğ’                                                 â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â”‚ Ğ”Ğ°Ğ½Ñ– Ğ±ĞµÑ€ÑƒÑ‚ÑŒÑÑ Ğ·:                                                   â”‚
â”‚     â”‚ â€¢ orders.payer_snapshot_json (Ñ€ĞµĞºĞ²Ñ–Ğ·Ğ¸Ñ‚Ğ¸ Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¸ĞºĞ°)                  â”‚
â”‚     â”‚ â€¢ orders.* (Ğ´ĞµÑ‚Ğ°Ğ»Ñ– Ğ¾Ñ€Ğ´ĞµÑ€Ğ°)                                         â”‚
â”‚     â”‚ â€¢ master_agreements.* (Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ´Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€Ñƒ)                             â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â–¼                                                                    â”‚
â”‚  6ï¸âƒ£ Ğ”ĞĞšĞ£ĞœĞ•ĞĞ¢Ğ˜ Ğ¡Ğ¢ĞĞ‘Ğ†Ğ›Ğ¬ĞĞ†                                                  â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â”‚ ĞĞ°Ğ²Ñ–Ñ‚ÑŒ ÑĞºÑ‰Ğ¾ Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¸Ğº Ğ¿Ğ¾Ñ‚Ñ–Ğ¼ Ğ·Ğ¼Ñ–Ğ½Ğ¸Ñ‚ÑŒ IBAN Ğ² payer_profiles,           â”‚
â”‚     â”‚ Ğ²ÑÑ– Ñ€Ğ°Ğ½Ñ–ÑˆĞµ Ğ·Ğ³ĞµĞ½ĞµÑ€Ğ¾Ğ²Ğ°Ğ½Ñ– Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¸ Ğ·Ğ°Ğ»Ğ¸ÑˆĞ°Ñ‚ÑŒÑÑ Ğ· ÑÑ‚Ğ°Ñ€Ğ¸Ğ¼ IBAN          â”‚
â”‚     â”‚ (Ğ±Ğ¾ Ğ²Ğ¾Ğ½Ğ¸ Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑÑ‚ÑŒ snapshot)                                  â”‚
â”‚     â”‚                                                                    â”‚
â”‚     â–¼                                                                    â”‚
â”‚  âœ… PROFIT!                                                               â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š ĞĞ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ° ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†ÑŒ

```sql
-- ĞšĞ»Ñ–Ñ”Ğ½Ñ‚Ğ¸ (ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ½Ñ– Ğ¾ÑĞ¾Ğ±Ğ¸)
CREATE TABLE client_users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    email VARCHAR(255),
    email_normalized VARCHAR(255) UNIQUE,  -- lower(trim(email))
    full_name VARCHAR(255),
    phone VARCHAR(50),
    company_hint VARCHAR(255),             -- ĞŸÑ–Ğ´ĞºĞ°Ğ·ĞºĞ° "Ğ¿Ñ€Ğ°Ñ†ÑÑ” Ğ²..."
    source ENUM('rentalhub', 'eventtool', 'manual'),
    notes TEXT,
    preferred_contact VARCHAR(50),         -- telegram/viber/whatsapp
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP ON UPDATE NOW()
);

-- ĞŸĞ»Ğ°Ñ‚Ğ½Ğ¸ĞºĞ¸ (ÑÑ€Ğ¸Ğ´Ğ¸Ñ‡Ğ½Ñ– Ñ€ĞµĞºĞ²Ñ–Ğ·Ğ¸Ñ‚Ğ¸)
CREATE TABLE payer_profiles (
    id INT PRIMARY KEY AUTO_INCREMENT,
    type ENUM('individual', 'fop', 'company', 'foreign', 'pending'),
    display_name VARCHAR(255) NOT NULL,    -- ĞĞ°Ğ·Ğ²Ğ° Ğ´Ğ»Ñ UI
    tax_mode ENUM('none', 'simplified', 'general', 'vat'),
    
    -- Ğ®Ñ€Ğ¸Ğ´Ğ¸Ñ‡Ğ½Ñ– Ğ´Ğ°Ğ½Ñ–
    legal_name VARCHAR(255),               -- ĞŸĞ¾Ğ²Ğ½Ğ° ÑÑ€. Ğ½Ğ°Ğ·Ğ²Ğ°
    edrpou VARCHAR(20),                    -- Ğ„Ğ”Ğ ĞŸĞĞ£/Ğ†ĞŸĞ
    iban VARCHAR(50),
    bank_name VARCHAR(255),
    address TEXT,
    
    -- ĞŸÑ–Ğ´Ğ¿Ğ¸ÑĞ°Ğ½Ñ‚
    signatory_name VARCHAR(255),           -- ĞŸĞ†Ğ‘ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ°
    signatory_basis VARCHAR(100),          -- "Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ‚Ñƒ" / "Ğ”Ğ¾Ğ²Ñ–Ñ€ĞµĞ½Ğ¾ÑÑ‚Ñ– â„–..."
    
    -- ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ¸ Ğ´Ğ»Ñ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ñ–Ğ²
    email_for_docs VARCHAR(255),
    phone_for_docs VARCHAR(50),
    
    -- ĞœĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ñ–
    details_json JSON,
    note TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP ON UPDATE NOW()
);

-- Ğ—Ğ²'ÑĞ·Ğ¾Ğº ĞºĞ»Ñ–Ñ”Ğ½Ñ‚ â†” Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¸Ğº (many-to-many)
CREATE TABLE client_payer_links (
    id INT PRIMARY KEY AUTO_INCREMENT,
    client_user_id INT NOT NULL,
    payer_profile_id INT NOT NULL,
    is_default BOOLEAN DEFAULT FALSE,      -- Ğ”ĞµÑ„Ğ¾Ğ»Ñ‚Ğ½Ğ¸Ğ¹ Ğ´Ğ»Ñ Ñ†ÑŒĞ¾Ğ³Ğ¾ ĞºĞ»Ñ–Ñ”Ğ½Ñ‚Ğ°
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE KEY (client_user_id, payer_profile_id),
    FOREIGN KEY (client_user_id) REFERENCES client_users(id),
    FOREIGN KEY (payer_profile_id) REFERENCES payer_profiles(id)
);

-- ĞÑ€Ğ´ĞµÑ€Ğ¸ (Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ– Ğ¿Ğ¾Ğ»Ñ)
ALTER TABLE orders ADD COLUMN client_user_id INT;
ALTER TABLE orders ADD COLUMN payer_profile_id INT;
ALTER TABLE orders ADD COLUMN payer_snapshot_json JSON;  -- FROZEN COPY!
ALTER TABLE orders ADD COLUMN active_annex_id INT;

-- Master Agreements (Ñ€Ğ°Ğ¼ĞºĞ¾Ğ²Ñ– Ğ´Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸ Ğ· Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¸ĞºĞ°Ğ¼Ğ¸)
CREATE TABLE master_agreements (
    id INT PRIMARY KEY AUTO_INCREMENT,
    payer_profile_id INT NOT NULL,         -- â† ĞšĞ›Ğ®Ğ§ĞĞ’Ğ˜Ğ™ Ğ—Ğ’'Ğ¯Ğ—ĞĞš
    payer_snapshot_json JSON,              -- Snapshot Ğ¿Ğ»Ğ°Ñ‚Ğ½Ğ¸ĞºĞ° Ğ½Ğ° Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚ MA
    agreement_number VARCHAR(50) UNIQUE,
    valid_from DATE NOT NULL,
    valid_to DATE NOT NULL,                -- valid_from + 12 months
    status ENUM('draft', 'active', 'signed', 'expired') DEFAULT 'draft',
    pdf_path VARCHAR(500),
    signed_at TIMESTAMP,
    signed_by VARCHAR(255),
    created_at TIMESTAMP DEFAULT NOW(),
    FOREIGN KEY (payer_profile_id) REFERENCES payer_profiles(id)
);

-- Annexes (Ğ´Ğ¾Ğ´Ğ°Ñ‚ĞºĞ¸ Ğ´Ğ¾ Ğ¾Ñ€Ğ´ĞµÑ€Ñ–Ğ²)
CREATE TABLE order_annexes (
    id INT PRIMARY KEY AUTO_INCREMENT,
    order_id INT NOT NULL,                 -- â† ĞšĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¸Ğ¹ Ğ¾Ñ€Ğ´ĞµÑ€
    master_agreement_id INT NOT NULL,      -- â† ĞŸĞ¾ÑĞ¸Ğ»Ğ°Ğ½Ğ½Ñ Ğ½Ğ° MA
    annex_number VARCHAR(50),
    version INT DEFAULT 1,
    status ENUM('draft', 'sent', 'signed') DEFAULT 'draft',
    pdf_path VARCHAR(500),
    created_at TIMESTAMP DEFAULT NOW(),
    FOREIGN KEY (order_id) REFERENCES orders(order_id),
    FOREIGN KEY (master_agreement_id) REFERENCES master_agreements(id)
);
```

---

## ğŸ—‚ï¸ 10. Ğ’ĞºĞ»Ğ°Ğ´ĞºĞ¸ Finance Hub (Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾)

| # | Ğ’ĞºĞ»Ğ°Ğ´ĞºĞ° | Ğ”Ğ¶ĞµÑ€ĞµĞ»Ğ¾ Ğ´Ğ°Ğ½Ğ¸Ñ… | ĞŸĞ¸ÑˆĞµ Ğ² |
|---|---------|---------------|--------|
| 1 | ğŸ’° ĞĞ¿ĞµÑ€Ğ°Ñ†Ñ–Ñ— | orders + fin_payments | fin_payments, fin_ledger |
| 2 | ğŸ“„ Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¸ | orders + master_agreements + annexes | master_agreements, order_annexes |
| 3 | ğŸ’µ ĞšĞ°ÑĞ¸ | fin_ledger_entries (aggregated) | â€” |
| 4 | ğŸ“Š ĞŸĞ»Ğ°Ğ½ Ğ½Ğ°Ğ´Ñ…Ğ¾Ğ´Ğ¶ĞµĞ½ÑŒ | orders (unpaid) | â€” |
| 5 | ğŸ“‰ Ğ’Ğ¸Ñ‚Ñ€Ğ°Ñ‚Ğ¸ | fin_expenses | fin_expenses, fin_ledger |
| 6 | ğŸ”’ Ğ”ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¸ | fin_deposit_holds | fin_deposit_holds |
| 7 | ğŸ“ˆ ĞĞ½Ğ°Ğ»Ñ–Ñ‚Ğ¸ĞºĞ° | all (aggregated) | â€” |
| 8 | ğŸ‘¥ ĞšĞ»Ñ–Ñ”Ğ½Ñ‚Ğ¸ | client_users + payer_profiles | client_users, payer_profiles, client_payer_links |

---

*Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚ Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾: 13.02.2026*
*Ğ’ĞµÑ€ÑÑ–Ñ: 2.0*
