# 📊 Діаграма Станів Замовлення

## Статуси замовлення та заморожування товарів

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         LIFE CYCLE ЗАМОВЛЕННЯ                           │
└─────────────────────────────────────────────────────────────────────────┘

                          [СТВОРЕННЯ]
                               ↓
                    ┌──────────────────────┐
                    │  awaiting_customer   │ ❌ НЕ ЗАМОРОЖЕНО
                    │  (Очікує клієнта)    │    (Клієнт може відмовитись)
                    └──────────────────────┘
                               ↓
                    [Менеджер підтверджує]
                    + check_availability()
                               ↓
                    ┌──────────────────────┐
                    │     processing       │ ✅ ЗАМОРОЖЕНО
                    │   (На комплектації)  │    (Склад збирає товари)
                    └──────────────────────┘
                               ↓
                    [Склад завершив збір]
                               ↓
                    ┌──────────────────────┐
                    │  ready_for_issue     │ ✅ ЗАМОРОЖЕНО
                    │ (Готово до видачі)   │    (Чекає клієнта)
                    └──────────────────────┘
                               ↓
                    [Видали клієнту]
                               ↓
                    ┌──────────────────────┐
                    │       issued         │ ✅ ЗАМОРОЖЕНО
                    │  (Видано клієнту)    │    (В оренді)
                    └──────────────────────┘
                               ↓
                               ↓
                    ┌──────────────────────┐
                    │      on_rent         │ ✅ ЗАМОРОЖЕНО
                    │     (В оренді)       │    (Клієнт використовує)
                    └──────────────────────┘
                               ↓
                    [Клієнт повернув]
                               ↓
                    ┌──────────────────────┐
                    │      returned        │ ✅ РОЗМОРОЖЕНО
                    │    (Повернуто)       │    (Товари знову доступні)
                    └──────────────────────┘
                               ↓
                    [Менеджер закрив]
                               ↓
                    ┌──────────────────────┐
                    │     completed        │ ✅ РОЗМОРОЖЕНО
                    │    (Завершено)       │    (Архів)
                    └──────────────────────┘


              [Альтернативні шляхи]

         ┌──────────────────────┐
         │     cancelled        │ ✅ РОЗМОРОЖЕНО
         │    (Скасовано)       │    (Клієнт відмовився)
         └──────────────────────┘
                  ↑
        (можна з будь-якого статусу)
```

---

## 🔍 Деталі Кожного Статусу

### **1. `awaiting_customer`** (Очікує підтвердження)
**Заморожування:** ❌ НІ  
**Доступність:** Товари доступні для інших замовлень  
**Де використовується:** Dashboard "Очікують підтвердження"  
**Дії:**
- Менеджер може підтвердити → `processing`
- Клієнт може відмінити → `cancelled`

---

### **2. `processing`** (На комплектації)
**Заморожування:** ✅ ТАК  
**Доступність:** Товари НЕДОСТУПНІ для інших  
**Де використовується:** IssueCard "На комплектації"  
**Що відбувається:**
- Створюється `issue_cards`
- Створюються `finance_transactions`
- Склад збирає товари
- Можна фіксувати пошкодження (`stage='pre_issue'`)

**Дії:**
- Склад завершив → `ready_for_issue`
- Скасування → `cancelled` (розморозить товари)

---

### **3. `ready_for_issue`** (Готово до видачі)
**Заморожування:** ✅ ТАК  
**Доступність:** Товари НЕДОСТУПНІ  
**Де використовується:** Dashboard "Готові до видачі"  
**Що відбувається:**
- Товари зібрані і чекають клієнта
- `issue_cards.status = 'ready'`
- `issue_cards.checklist` заповнений

**Дії:**
- Видача клієнту → `issued`
- Клієнт не з'явився → `cancelled`

---

### **4. `issued`** (Видано)
**Заморожування:** ✅ ТАК  
**Доступність:** Товари В ОРЕНДІ  
**Де використовується:** Dashboard "Видані"  
**Що відбувається:**
- Товари у клієнта
- `issue_cards.status = 'issued'`
- `issue_cards.issued_at` встановлено

**Дії:**
- Автоматично → `on_rent` (опціонально)
- Повернення → `returned`

---

### **5. `on_rent`** (В оренді)
**Заморожування:** ✅ ТАК  
**Доступність:** Товари В ОРЕНДІ  
**Де використовується:** Dashboard "В оренді"  
**Що відбувається:**
- Аналогічно `issued`
- Може використовуватись для розділення станів

**Дії:**
- Повернення → `returned`

---

### **6. `returned`** (Повернуто)
**Заморожування:** ✅ РОЗМОРОЖЕНО  
**Доступність:** Товари ДОСТУПНІ  
**Де використовується:** Dashboard "Повернення"  
**Що відбувається:**
- Товари повернулись
- Зафіксовані пошкодження (`stage='return'`)
- Нараховані збитки (`late_fee`, `damage_fee`)
- Створені `finance_transactions` для збитків

**Дії:**
- Менеджер закриває → `completed`

---

### **7. `completed`** (Завершено)
**Заморожування:** ✅ РОЗМОРОЖЕНО  
**Доступність:** Товари ДОСТУПНІ  
**Де використовується:** Архів  
**Що відбувається:**
- Всі фінансові питання вирішені
- Архівний статус

---

### **8. `cancelled`** (Скасовано)
**Заморожування:** ✅ РОЗМОРОЖЕНО  
**Доступність:** Товари ДОСТУПНІ  
**Де використовується:** Архів скасованих  
**Що відбувається:**
- Замовлення скасовано
- Товари звільнені
- `finance_transactions` можуть бути відмінені

---

## 📋 Таблиця Заморожування

| Статус              | Заморожено | Враховується в availability | Можна нове замовлення |
|---------------------|------------|-----------------------------|-----------------------|
| `awaiting_customer` | ❌ НІ      | ❌ НІ                       | ✅ ТАК                |
| `processing`        | ✅ ТАК     | ✅ ТАК                      | ❌ НІ                 |
| `ready_for_issue`   | ✅ ТАК     | ✅ ТАК                      | ❌ НІ                 |
| `issued`            | ✅ ТАК     | ✅ ТАК                      | ❌ НІ                 |
| `on_rent`           | ✅ ТАК     | ✅ ТАK                      | ❌ НІ                 |
| `returned`          | ❌ НІ      | ❌ НІ                       | ✅ ТАК                |
| `completed`         | ❌ НІ      | ❌ НІ                       | ✅ ТАК                |
| `cancelled`         | ❌ НІ      | ❌ НІ                       | ✅ ТАК                |

---

## 🔄 SQL Запити для Перевірки

### **Заморожені товари (недоступні):**
```sql
SELECT SUM(oi.quantity) as frozen
FROM order_items oi
JOIN orders o ON oi.order_id = o.order_id
WHERE oi.product_id = ?
  AND o.status IN ('processing', 'ready_for_issue', 'issued', 'on_rent')
  AND o.rental_start_date <= ?
  AND o.rental_end_date >= ?
```

### **Доступні товари:**
```sql
SELECT 
  p.quantity - COALESCE(frozen.qty, 0) as available
FROM products p
LEFT JOIN (
  -- підзапит на заморожені
) frozen ON frozen.product_id = p.product_id
```

---

## 🎯 Ключові Переходи

### **Критичний перехід (ЗАМОРОЖУВАННЯ):**
```
awaiting_customer → processing
```
- ✅ Перевірка доступності (ОБОВ'ЯЗКОВО!)
- ✅ Товари стають недоступними
- ✅ Створюються фінансові транзакції

### **Критичний перехід (РОЗМОРОЖУВАННЯ):**
```
issued/on_rent → returned
```
- ✅ Товари стають доступними
- ✅ Фіксація пошкоджень
- ✅ Нарахування збитків

---

Система працює цілісно! 🚀
