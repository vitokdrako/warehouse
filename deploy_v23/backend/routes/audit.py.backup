"""
Audit Cabinet API - –ö–∞–±—ñ–Ω–µ—Ç –ø–µ—Ä–µ–æ–±–ª—ñ–∫—É
"""
from fastapi import APIRouter, HTTPException, Depends
from typing import List, Optional
from sqlalchemy.orm import Session
from sqlalchemy import func, and_, or_, desc, text
from datetime import datetime, timedelta
import uuid

from database import get_db
from models_sqlalchemy import (
    OpenCartProduct,
    OpenCartProductDescription,
    OpenCartProductToCategory,
    OpenCartCategory,
    OpenCartCategoryDescription,
    DecorProductExtended,
    DecorProductCatalog,
    DecorInventoryItem,
    DecorProductHistory,
    DecorOrder,
    DecorIssueCard,
    DecorDamage,
    DecorDamageItem,
    FinanceTransaction
)

router = APIRouter(prefix="/api/audit", tags=["audit"])


# Helper to calculate days from last audit
def days_from_date(date_obj):
    if not date_obj:
        return 999
    try:
        from datetime import date as date_type
        
        if isinstance(date_obj, str):
            audit_date = datetime.strptime(date_obj, "%Y-%m-%d").date()
        elif isinstance(date_obj, date_type):
            audit_date = date_obj
        elif isinstance(date_obj, datetime):
            audit_date = date_obj.date()
        else:
            return 999
            
        today = datetime.now().date()
        delta = (today - audit_date).days
        return delta
    except Exception as e:
        print(f"Error calculating days from date: {e}")
        return 999


@router.get("/items")
async def get_audit_items(
    q: Optional[str] = None,
    category: Optional[str] = None,
    subcategory: Optional[str] = None,
    sort_by: Optional[str] = 'category',
    limit: int = 100,  # –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º —Ç—ñ–ª—å–∫–∏ 100 —Ç–æ–≤–∞—Ä—ñ–≤
    db: Session = Depends(get_db)
):
    """
    –û—Ç—Ä–∏–º–∞—Ç–∏ —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä—ñ–≤ –¥–ª—è –ø–µ—Ä–µ–æ–±–ª—ñ–∫—É
    """
    try:
        # Base query –∑ JOIN –≤—Å—ñ—Ö –ø–æ—Ç—Ä—ñ–±–Ω–∏—Ö —Ç–∞–±–ª–∏—Ü—å (–±–µ–∑ DecorInventoryItem –¥–ª—è —à–≤–∏–¥–∫–æ—Å—Ç—ñ)
        query = db.query(
            OpenCartProduct,
            OpenCartProductDescription,
            DecorProductExtended,
            DecorProductCatalog
        ).join(
            OpenCartProductDescription,
            OpenCartProduct.product_id == OpenCartProductDescription.product_id
        ).outerjoin(
            DecorProductExtended,
            OpenCartProduct.product_id == DecorProductExtended.product_id
        ).outerjoin(
            DecorProductCatalog,
            OpenCartProduct.product_id == DecorProductCatalog.product_id
        ).filter(
            OpenCartProduct.status == 1,
            OpenCartProductDescription.language_id == 4
        )
        
        # –§—ñ–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó - JOIN –∑ oc_product_to_category —Ç–∞ oc_category_description
        filter_category_name = None
        if category and category != 'all':
            filter_category_name = category
            query = query.join(
                OpenCartProductToCategory,
                OpenCartProduct.product_id == OpenCartProductToCategory.product_id
            ).join(
                OpenCartCategoryDescription,
                and_(
                    OpenCartProductToCategory.category_id == OpenCartCategoryDescription.category_id,
                    OpenCartCategoryDescription.language_id == 4
                )
            ).filter(
                OpenCartCategoryDescription.name == category
            )
        
        # –§—ñ–ª—å—Ç—Ä –ø–æ –ø–æ—à—É–∫—É - —Ç—ñ–ª—å–∫–∏ –ø–æ SKU (model), –∫–æ–ª—å–æ—Ä—É, –º–∞—Ç–µ—Ä—ñ–∞–ª—É
        if q:
            search_pattern = f"%{q}%"
            query = query.filter(
                or_(
                    OpenCartProduct.model.like(search_pattern),
                    OpenCartProductDescription.name.like(search_pattern),
                    DecorProductExtended.color.like(search_pattern),
                    DecorProductExtended.material.like(search_pattern)
                )
            )
        
        if subcategory and subcategory != 'all':
            query = query.filter(DecorProductExtended.subcategory == subcategory)
        
        results = query.limit(limit).all()
        
        # –§–æ—Ä–º—É–≤–∞–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
        audit_items = []
        seen_products = set()
        
        for oc_prod, oc_desc, extended, catalog in results:
            # –£–Ω—ñ–∫–∞–ª—å–Ω—ñ—Å—Ç—å –ø–æ product_id
            if oc_prod.product_id in seen_products:
                continue
            seen_products.add(oc_prod.product_id)
            
            # Inventory –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è, –æ—Å–∫—ñ–ª—å–∫–∏ —Ç–∞–±–ª–∏—Ü—è –Ω–µ —ñ—Å–Ω—É—î
            inventory = None
            
            # Location
            zone_str = "–°–∫–ª–∞–¥"
            location_str = "–ù–µ –≤–∫–∞–∑–∞–Ω–æ"
            if catalog:
                zone_str = f"–ó–æ–Ω–∞ {catalog.location_zone}" if catalog.location_zone else "–°–∫–ª–∞–¥"
                parts = []
                if catalog.location_aisle:
                    parts.append(catalog.location_aisle)
                if catalog.location_shelf:
                    parts.append(catalog.location_shelf)
                location_str = "".join(parts) if parts else "–ù–µ –≤–∫–∞–∑–∞–Ω–æ"
            
            # Category - –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–æ–≤–∞–Ω—É –∫–∞—Ç–µ–≥–æ—Ä—ñ—é, —è–∫—â–æ —î, —ñ–Ω–∞–∫—à–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ –∑ OpenCart
            if filter_category_name:
                cat_main = filter_category_name
            else:
                cat_query = text("""
                    SELECT cd.name
                    FROM oc_product_to_category ptc
                    JOIN oc_category_description cd ON ptc.category_id = cd.category_id
                    WHERE ptc.product_id = :product_id AND cd.language_id = 4
                    LIMIT 1
                """)
                cat_result = db.execute(cat_query, {"product_id": oc_prod.product_id}).fetchone()
                cat_main = cat_result[0] if cat_result else "–ó–∞–≥–∞–ª—å–Ω–µ"
            cat_full = f"{cat_main}"
            
            # Audit data - –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç: inventory, –ø–æ—Ç—ñ–º catalog
            last_audit = None
            last_audit_by = None
            next_audit = None
            audit_status = 'ok'
            audit_notes = ''
            days_from_audit = 999
            
            # –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑ inventory
            if inventory:
                if inventory.last_audit_date:
                    last_audit = inventory.last_audit_date.isoformat()
                    days_from_audit = days_from_date(inventory.last_audit_date)
                last_audit_by = inventory.last_audit_by
                if inventory.next_audit_date:
                    next_audit = inventory.next_audit_date.isoformat()
                audit_status = inventory.audit_status or 'ok'
                audit_notes = inventory.audit_notes or ''
            # –Ø–∫—â–æ –Ω–µ–º–∞—î inventory, –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ catalog
            elif catalog:
                if catalog.last_audit_date:
                    last_audit = catalog.last_audit_date.isoformat()
                    days_from_audit = days_from_date(catalog.last_audit_date)
                last_audit_by = catalog.last_audit_by
                if catalog.next_audit_date:
                    next_audit = catalog.next_audit_date.isoformat()
            
            # –†–∞—Ö—É—î–º–æ lifecycle –º–µ—Ç—Ä–∏–∫–∏ –∑ –û–ë–û–• —Å–∏—Å—Ç–µ–º (OpenCart + –Ω–æ–≤—ñ —Ç–∞–±–ª–∏—Ü—ñ)
            
            # 1. –ö—ñ–ª—å–∫—ñ—Å—Ç—å –æ—Ä–µ–Ω–¥ —Ç–∞ –¥–æ—Ö—ñ–¥ –∑ OpenCart (—Å—Ç–∞—Ä—ñ –¥–∞–Ω—ñ)
            oc_rentals_query = text("""
                SELECT COUNT(DISTINCT op.order_id) as rentals_count,
                       COALESCE(SUM(op.total), 0) as total_profit
                FROM oc_order_product op
                INNER JOIN oc_order o ON op.order_id = o.order_id
                WHERE op.product_id = :product_id
                AND o.order_status_id NOT IN (7)
            """)
            oc_result = db.execute(oc_rentals_query, {"product_id": oc_prod.product_id}).fetchone()
            oc_rentals = oc_result[0] if oc_result else 0
            oc_profit = oc_result[1] if oc_result else 0
            
            # 2. –ö—ñ–ª—å–∫—ñ—Å—Ç—å –æ—Ä–µ–Ω–¥ —Ç–∞ –¥–æ—Ö—ñ–¥ –∑ –Ω–æ–≤–∏—Ö —Ç–∞–±–ª–∏—Ü—å (–Ω–æ–≤—ñ –¥–∞–Ω—ñ)
            from models_sqlalchemy import DecorOrderItem
            new_rentals = db.query(func.count(func.distinct(DecorOrderItem.order_id))).filter(
                DecorOrderItem.product_id == oc_prod.product_id
            ).scalar() or 0
            
            new_profit = db.query(func.sum(DecorOrderItem.total_rental)).filter(
                DecorOrderItem.product_id == oc_prod.product_id
            ).scalar() or 0
            
            # –û–±'—î–¥–Ω–∞—Ç–∏ –¥–∞–Ω—ñ –∑ –æ–±–æ—Ö —Å–∏—Å—Ç–µ–º
            total_rentals = oc_rentals + new_rentals
            total_profit = float(oc_profit or 0) + float(new_profit or 0)
            
            # 3. –ö—ñ–ª—å–∫—ñ—Å—Ç—å –∫–µ–π—Å—ñ–≤ —à–∫–æ–¥–∏
            damages_count = db.query(func.count(DecorDamageItem.id)).filter(
                DecorDamageItem.product_id == oc_prod.product_id
            ).scalar() or 0
            
            # 4. –û—Å—Ç–∞–Ω–Ω—î –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
            last_new_order = db.query(DecorOrderItem.order_id).filter(
                DecorOrderItem.product_id == oc_prod.product_id
            ).order_by(DecorOrderItem.created_at.desc()).first()
            
            if last_new_order:
                last_order_id = str(last_new_order[0])
            else:
                last_oc_order_query = text("""
                    SELECT op.order_id
                    FROM oc_order_product op
                    WHERE op.product_id = :product_id
                    ORDER BY op.order_product_id DESC
                    LIMIT 1
                """)
                last_oc_result = db.execute(last_oc_order_query, {"product_id": oc_prod.product_id}).fetchone()
                last_order_id = str(last_oc_result[0]) if last_oc_result else None
            
            # –û—Ç—Ä–∏–º–∞—Ç–∏ –∫–æ–ª—ñ—Ä —Ç–∞ –º–∞—Ç–µ—Ä—ñ–∞–ª –∑ OpenCart –∞—Ç—Ä–∏–±—É—Ç—ñ–≤
            color_attr = db.execute(text("""
                SELECT text FROM oc_product_attribute 
                WHERE product_id = :pid AND attribute_id = 13 AND language_id = 4
            """), {"pid": oc_prod.product_id}).fetchone()
            
            material_attr = db.execute(text("""
                SELECT text FROM oc_product_attribute 
                WHERE product_id = :pid AND attribute_id = 16 AND language_id = 4
            """), {"pid": oc_prod.product_id}).fetchone()
            
            color_val = color_attr[0] if color_attr else None
            material_val = material_attr[0] if material_attr else None
            
            # –û—Ç—Ä–∏–º–∞—Ç–∏ —Ä–æ–∑–º—ñ—Ä
            size_val = extended.size if extended else None
            
            # –û—Ç—Ä–∏–º–∞—Ç–∏ —Ñ–æ—Ç–æ
            image_url = f"https://farforrent.com.ua/image/{oc_prod.image}" if oc_prod.image else None
            
            audit_items.append({
                'id': f"A-{oc_prod.product_id}",
                'product_id': oc_prod.product_id,
                'code': oc_prod.model,
                'name': oc_desc.name,
                'description': oc_desc.description,
                'careInstructions': extended.care_notes if extended else None,
                'category': cat_full,
                'zone': zone_str,
                'location': location_str,
                'qty': int(oc_prod.quantity) if oc_prod.quantity else 0,
                'status': audit_status,
                'lastAuditDate': last_audit or '2024-01-01',
                'lastAuditBy': last_audit_by,
                'nextAuditDate': next_audit,
                'daysFromLastAudit': days_from_audit,
                'rentalsCount': total_rentals,
                'lastOrderId': last_order_id,
                'damagesCount': damages_count,
                'totalProfit': float(total_profit),
                'notes': audit_notes,
                'color': color_val,
                'material': material_val,
                'size': size_val,
                'imageUrl': image_url
            })
        
        return audit_items
        
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"–ü–æ–º–∏–ª–∫–∞: {str(e)}")


@router.get("/items/{item_id}")
async def get_audit_item_details(
    item_id: str,
    db: Session = Depends(get_db)
):
    """
    –î–µ—Ç–∞–ª—ñ —Ç–æ–≤–∞—Ä—É –¥–ª—è –ø–µ—Ä–µ–æ–±–ª—ñ–∫—É
    """
    try:
        # Parse product_id from A-123
        product_id = int(item_id.replace('A-', ''))
        
        # Query
        product = db.query(OpenCartProduct).filter(
            OpenCartProduct.product_id == product_id
        ).first()
        
        if not product:
            raise HTTPException(status_code=404, detail="–¢–æ–≤–∞—Ä –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ")
        
        description = db.query(OpenCartProductDescription).filter(
            OpenCartProductDescription.product_id == product_id,
            OpenCartProductDescription.language_id == 4
        ).first()
        
        extended = db.query(DecorProductExtended).filter(
            DecorProductExtended.product_id == product_id
        ).first()
        
        catalog = db.query(DecorProductCatalog).filter(
            DecorProductCatalog.product_id == product_id
        ).first()
        
        inventory = db.query(DecorInventoryItem).filter(
            DecorInventoryItem.product_id == product_id
        ).first()
        
        # Build response (same as list)
        zone_str = "–°–∫–ª–∞–¥"
        location_str = "–ù–µ –≤–∫–∞–∑–∞–Ω–æ"
        if catalog:
            zone_str = f"–ó–æ–Ω–∞ {catalog.location_zone}" if catalog.location_zone else "–°–∫–ª–∞–¥"
            parts = []
            if catalog.location_aisle:
                parts.append(catalog.location_aisle)
            if catalog.location_shelf:
                parts.append(catalog.location_shelf)
            location_str = "".join(parts) if parts else "–ù–µ –≤–∫–∞–∑–∞–Ω–æ"
        
        # Category - –æ—Ç—Ä–∏–º–∞—Ç–∏ –∑ OpenCart
        cat_query = text("""
            SELECT cd.name
            FROM oc_product_to_category ptc
            JOIN oc_category_description cd ON ptc.category_id = cd.category_id
            WHERE ptc.product_id = :product_id AND cd.language_id = 4
            LIMIT 1
        """)
        cat_result = db.execute(cat_query, {"product_id": product_id}).fetchone()
        cat_main = cat_result[0] if cat_result else "–ó–∞–≥–∞–ª—å–Ω–µ"
        
        last_audit = None
        last_audit_by = None
        next_audit = None
        audit_status = 'ok'
        audit_notes = ''
        days_from_audit = 999
        
        if inventory:
            if inventory.last_audit_date:
                last_audit = inventory.last_audit_date.isoformat()
                days_from_audit = days_from_date(inventory.last_audit_date)
            last_audit_by = inventory.last_audit_by
            if inventory.next_audit_date:
                next_audit = inventory.next_audit_date.isoformat()
            audit_status = inventory.audit_status or 'ok'
            audit_notes = inventory.audit_notes or ''
        
        # –†–∞—Ö—É—î–º–æ lifecycle –º–µ—Ç—Ä–∏–∫–∏ –∑ –û–ë–û–• —Å–∏—Å—Ç–µ–º (OpenCart + –Ω–æ–≤—ñ —Ç–∞–±–ª–∏—Ü—ñ)
        
        # 1. –î–∞–Ω—ñ –∑ OpenCart (—Å—Ç–∞—Ä—ñ)
        oc_rentals_query = text("""
            SELECT COUNT(DISTINCT op.order_id) as rentals_count,
                   COALESCE(SUM(op.total), 0) as total_profit
            FROM oc_order_product op
            INNER JOIN oc_order o ON op.order_id = o.order_id
            WHERE op.product_id = :product_id
            AND o.order_status_id NOT IN (7)
        """)
        oc_result = db.execute(oc_rentals_query, {"product_id": product_id}).fetchone()
        oc_rentals = oc_result[0] if oc_result else 0
        oc_profit = oc_result[1] if oc_result else 0
        
        # 2. –î–∞–Ω—ñ –∑ –Ω–æ–≤–∏—Ö —Ç–∞–±–ª–∏—Ü—å
        from models_sqlalchemy import DecorOrderItem
        new_rentals = db.query(func.count(func.distinct(DecorOrderItem.order_id))).filter(
            DecorOrderItem.product_id == product_id
        ).scalar() or 0
        
        new_profit = db.query(func.sum(DecorOrderItem.total_rental)).filter(
            DecorOrderItem.product_id == product_id
        ).scalar() or 0
        
        # –û–±'—î–¥–Ω–∞—Ç–∏
        rentals_count = oc_rentals + new_rentals
        total_profit = float(oc_profit) + float(new_profit)
        
        # 3. –ö–µ–π—Å–∏ —à–∫–æ–¥–∏
        damages_count = db.query(func.count(DecorDamageItem.id)).filter(
            DecorDamageItem.product_id == product_id
        ).scalar() or 0
        
        # 4. –û—Å—Ç–∞–Ω–Ω—î –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è
        last_new_order = db.query(DecorOrderItem.order_id).filter(
            DecorOrderItem.product_id == product_id
        ).order_by(DecorOrderItem.created_at.desc()).first()
        
        if last_new_order:
            last_order_id = last_new_order[0]
        else:
            last_oc_order_query = text("""
                SELECT op.order_id
                FROM oc_order_product op
                WHERE op.product_id = :product_id
                ORDER BY op.order_product_id DESC
                LIMIT 1
            """)
            last_oc_result = db.execute(last_oc_order_query, {"product_id": product_id}).fetchone()
            last_order_id = last_oc_result[0] if last_oc_result else None
        
        # –û—Ç—Ä–∏–º–∞—Ç–∏ –∫–æ–ª—ñ—Ä —Ç–∞ –º–∞—Ç–µ—Ä—ñ–∞–ª –∑ OpenCart –∞—Ç—Ä–∏–±—É—Ç—ñ–≤
        color_attr = db.execute(text("""
            SELECT text FROM oc_product_attribute 
            WHERE product_id = :pid AND attribute_id = 13 AND language_id = 4
        """), {"pid": product_id}).fetchone()
        
        material_attr = db.execute(text("""
            SELECT text FROM oc_product_attribute 
            WHERE product_id = :pid AND attribute_id = 16 AND language_id = 4
        """), {"pid": product_id}).fetchone()
        
        color_val = color_attr[0] if color_attr else None
        material_val = material_attr[0] if material_attr else None
        
        # –û—Ç—Ä–∏–º–∞—Ç–∏ —Ä–æ–∑–º—ñ—Ä –∑ extended
        size_val = extended.size if extended else None
        
        # –û—Ç—Ä–∏–º–∞—Ç–∏ —Ñ–æ—Ç–æ
        image_url = f"https://farforrent.com.ua/image/{product.image}" if product.image else None
        
        # –û—Ç—Ä–∏–º–∞—Ç–∏ –æ–ø–∏—Å —Ç–∞ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—é –ø–æ –¥–æ–≥–ª—è–¥—É
        product_description = description.description if description and description.description else None
        
        # –û—Ç—Ä–∏–º–∞—Ç–∏ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—é –∑ decor_product_extended (–ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç)
        care_instructions = None
        if extended and extended.care_notes:
            care_instructions = extended.care_notes
        else:
            # Fallback: —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏ –≤–∑—è—Ç–∏ –∑ –∞—Ç—Ä–∏–±—É—Ç—ñ–≤ OpenCart
            care_instructions_attr = db.execute(text("""
                SELECT text FROM oc_product_attribute 
                WHERE product_id = :pid AND attribute_id = 17 AND language_id = 4
            """), {"pid": product_id}).fetchone()
            care_instructions = care_instructions_attr[0] if care_instructions_attr else None
        
        return {
            'id': item_id,
            'product_id': product_id,
            'code': product.model,
            'name': description.name if description else '–ë–µ–∑ –Ω–∞–∑–≤–∏',
            'description': product_description,
            'careInstructions': care_instructions,
            'category': cat_main,
            'zone': zone_str,
            'location': location_str,
            'qty': int(product.quantity) if product.quantity else 0,
            'status': audit_status,
            'lastAuditDate': last_audit or '2024-01-01',
            'lastAuditBy': last_audit_by,
            'nextAuditDate': next_audit,
            'daysFromLastAudit': days_from_audit,
            'rentalsCount': rentals_count,
            'lastOrderId': last_order_id,
            'damagesCount': damages_count,
            'totalProfit': float(total_profit),
            'notes': audit_notes,
            'color': color_val,
            'material': material_val,
            'size': size_val,
            'imageUrl': image_url
        }
        
    except HTTPException:
        raise
    except Exception as e:
        raise HTTPException(
            status_code=500,
            detail=f"–ü–æ–º–∏–ª–∫–∞: {str(e)}"
        )


@router.put("/items/{item_id}/update-info")
async def update_product_info(
    item_id: str,
    data: dict,
    db: Session = Depends(get_db)
):
    """
    –û–Ω–æ–≤–∏—Ç–∏ –æ–ø–∏—Å —Ç–æ–≤–∞—Ä—É —Ç–∞ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—é –ø–æ –¥–æ–≥–ª—è–¥—É
    """
    try:
        product_id = int(item_id.replace('A-', ''))
        
        # 1. –û–Ω–æ–≤–∏—Ç–∏ –æ–ø–∏—Å –≤ oc_product_description
        if 'description' in data:
            db.execute(text("""
                UPDATE oc_product_description 
                SET description = :desc
                WHERE product_id = :pid AND language_id = 4
            """), {
                'desc': data['description'],
                'pid': product_id
            })
        
        # 2. –û–Ω–æ–≤–∏—Ç–∏ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—é –¥–æ–≥–ª—è–¥—É –≤ decor_product_extended
        if 'care_instructions' in data:
            # –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ —ñ—Å–Ω—É—î –∑–∞–ø–∏—Å
            existing = db.execute(text("""
                SELECT product_id FROM decor_product_extended WHERE product_id = :pid
            """), {'pid': product_id}).fetchone()
            
            if existing:
                db.execute(text("""
                    UPDATE decor_product_extended 
                    SET care_notes = :care
                    WHERE product_id = :pid
                """), {
                    'care': data['care_instructions'],
                    'pid': product_id
                })
            else:
                db.execute(text("""
                    INSERT INTO decor_product_extended (product_id, care_notes)
                    VALUES (:pid, :care)
                """), {
                    'pid': product_id,
                    'care': data['care_instructions']
                })
        
        # 3. –¢–∞–∫–æ–∂ –æ–Ω–æ–≤–∏—Ç–∏ –∞—Ç—Ä–∏–±—É—Ç (–¥–ª—è —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ)
        if 'care_instructions' in data:
            # –í–∏–¥–∞–ª–∏—Ç–∏ —Å—Ç–∞—Ä–∏–π –∑–∞–ø–∏—Å
            db.execute(text("""
                DELETE FROM oc_product_attribute 
                WHERE product_id = :pid AND attribute_id = 17 AND language_id = 4
            """), {'pid': product_id})
            
            # –î–æ–¥–∞—Ç–∏ –Ω–æ–≤–∏–π
            if data['care_instructions']:
                db.execute(text("""
                    INSERT INTO oc_product_attribute (product_id, attribute_id, language_id, text)
                    VALUES (:pid, 17, 4, :care)
                """), {
                    'pid': product_id,
                    'care': data['care_instructions']
                })
        
        db.commit()
        
        return {
            'success': True,
            'message': '–û–ø–∏—Å —Ç–∞ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—é –æ–Ω–æ–≤–ª–µ–Ω–æ'
        }
        
    except Exception as e:
        db.rollback()
        raise HTTPException(
            status_code=500,
            detail=f"–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è: {str(e)}"
        )


@router.post("/items/{item_id}/mark-as-audited")
async def mark_audited_new_working_endpoint(item_id: str, audit_data: dict, db: Session = Depends(get_db)):
    """–†–û–ë–û–ß–ò–ô endpoint –¥–ª—è —Ñ—ñ–∫—Å–∞—Ü—ñ—ó –ø–µ—Ä–µ–æ–±–ª—ñ–∫—É"""
    import sys
    sys.stderr.write(f"üî• MARK AUDITED CALLED for {item_id}\n")
    sys.stderr.flush()
    
    try:
        product_id = int(item_id.replace('A-', ''))
        today = datetime.now().date()
        audited_by = audit_data.get('audited_by', '–†–µ–∫–≤—ñ–∑–∏—Ç–æ—Ä')
        
        sys.stderr.write(f"üìù product_id={product_id}, audited_by={audited_by}\n")
        sys.stderr.flush()
        
        # –ü—Ä—è–º–∏–π UPDATE —á–µ—Ä–µ–∑ raw SQL
        update_sql = text("""
            INSERT INTO decor_product_catalog 
            (product_id, last_audit_date, last_audit_by, next_audit_date, created_at)
            VALUES 
            (:product_id, :last_audit_date, :last_audit_by, :next_audit_date, NOW())
            ON DUPLICATE KEY UPDATE
            last_audit_date = :last_audit_date,
            last_audit_by = :last_audit_by,
            next_audit_date = :next_audit_date
        """)
        
        next_audit_date = None
        if audit_data.get('next_audit_days'):
            days = int(audit_data['next_audit_days'])
            next_audit_date = (datetime.now() + timedelta(days=days)).date()
        
        sys.stderr.write(f"üîß Executing SQL UPDATE...\n")
        sys.stderr.flush()
        
        db.execute(update_sql, {
            'product_id': product_id,
            'last_audit_date': today,
            'last_audit_by': audited_by,
            'next_audit_date': next_audit_date
        })
        
        # –ó–∞–ø–∏—Å –≤ audits
        audit_id = f"AUDIT-{uuid.uuid4().hex[:8].upper()}"
        audit_insert = text("""
            INSERT INTO decor_product_audits 
            (id, product_id, audit_date, audited_by, audit_status, audit_notes)
            VALUES 
            (:audit_id, :product_id, CURDATE(), :audited_by, :audit_status, :notes)
        """)
        db.execute(audit_insert, {
            'audit_id': audit_id,
            'product_id': product_id,
            'audited_by': audited_by,
            'audit_status': audit_data.get('audit_status', 'ok'),
            'notes': audit_data.get('notes', '')
        })
        
        sys.stderr.write(f"üíæ Committing...\n")
        sys.stderr.flush()
        
        db.commit()
        
        sys.stderr.write(f"‚úÖ SUCCESS! product_id={product_id}, audit_id={audit_id}\n")
        sys.stderr.flush()
        
        return {
            'success': True,
            'message': '–ü–µ—Ä–µ–æ–±–ª—ñ–∫ –∑–∞—Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ',
            'item_id': item_id,
            'audit_id': audit_id
        }
    except Exception as e:
        sys.stderr.write(f"‚ùå Error: {str(e)}\n")
        sys.stderr.flush()
        db.rollback()
        raise HTTPException(status_code=500, detail=str(e))

@router.put("/items/{item_id}/audit-DISABLED-FOR-TEST")
async def mark_item_audited_v2_fixed(
    item_id: str,
    audit_data: dict,
    db: Session = Depends(get_db)
):
    """
    DISABLED FOR TESTING
    """
    import sys
    sys.stdout.flush()
    sys.stderr.write(f"[AUDIT ENDPOINT] ‚úÖ –í–ò–ö–õ–ò–ö–ê–ù–û! item_id={item_id}\n")
    sys.stderr.write(f"[AUDIT ENDPOINT] audit_data={audit_data}\n")
    sys.stderr.flush()
    
    try:
        product_id = int(item_id.replace('A-', ''))
        
        sys.stderr.write(f"[AUDIT] product_id={product_id}\n")
        sys.stderr.write(f"[AUDIT] –ì–æ—Ç—É—î–º–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–ª—è DecorProductCatalog...\n")
        sys.stderr.flush()
        
        # –û–Ω–æ–≤–∏—Ç–∏ DecorProductCatalog —á–µ—Ä–µ–∑ raw SQL (–±—ñ–ª—å—à –Ω–∞–¥—ñ–π–Ω–æ)
        today = datetime.now().date()
        audited_by = audit_data.get('audited_by', '–†–µ–∫–≤—ñ–∑–∏—Ç–æ—Ä')
        
        sys.stderr.write(f"[AUDIT] üìù –û–Ω–æ–≤–ª—é—î–º–æ catalog –¥–ª—è product_id={product_id}\n")
        sys.stderr.write(f"[AUDIT] üìÖ –î–∞—Ç–∞: {today}, –•—Ç–æ: {audited_by}\n")
        sys.stderr.flush()
        
        # –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ INSERT –∞–±–æ UPDATE
        update_catalog = text("""
            INSERT INTO decor_product_catalog 
            (product_id, last_audit_date, last_audit_by, next_audit_date, created_at)
            VALUES 
            (:product_id, :last_audit_date, :last_audit_by, :next_audit_date, NOW())
            ON DUPLICATE KEY UPDATE
            last_audit_date = :last_audit_date,
            last_audit_by = :last_audit_by,
            next_audit_date = :next_audit_date
        """)
        
        next_audit_date = None
        if audit_data.get('next_audit_days'):
            days = int(audit_data['next_audit_days'])
            next_audit_date = (datetime.now() + timedelta(days=days)).date()
            sys.stderr.write(f"[AUDIT] Setting next_audit_date={next_audit_date} (+{days} days)\n")
            sys.stderr.flush()
        
        sys.stderr.write(f"[AUDIT] –í–∏–∫–æ–Ω—É—î–º–æ SQL UPDATE...\n")
        sys.stderr.flush()
        
        db.execute(update_catalog, {
            'product_id': product_id,
            'last_audit_date': today,
            'last_audit_by': audited_by,
            'next_audit_date': next_audit_date
        })
        
        # –°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–ø–∏—Å –≤ —ñ—Å—Ç–æ—Ä—ñ—ó
        history = DecorProductHistory(
            id=f"H-{uuid.uuid4().hex[:8].upper()}",
            product_id=product_id,
            inventory_item_id=None,
            event_type='cleaned',  # audit event
            actor=audit_data.get('audited_by', '–†–µ–∫–≤—ñ–∑–∏—Ç–æ—Ä'),
            notes=f"–ü–µ—Ä–µ–æ–±–ª—ñ–∫: {audit_data.get('notes', '—Å—Ç–∞–Ω –ø–µ—Ä–µ–≤—ñ—Ä–µ–Ω–æ')}"
        )
        db.add(history)
        
        # –°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–ø–∏—Å –≤ decor_product_audits
        audit_id = f"AUDIT-{uuid.uuid4().hex[:8].upper()}"
        audit_insert = text("""
            INSERT INTO decor_product_audits 
            (id, product_id, audit_date, audited_by, audit_status, audit_notes)
            VALUES 
            (:audit_id, :product_id, CURDATE(), :audited_by, :audit_status, :notes)
        """)
        db.execute(audit_insert, {
            'audit_id': audit_id,
            'product_id': product_id,
            'audited_by': audit_data.get('audited_by', '–†–µ–∫–≤—ñ–∑–∏—Ç–æ—Ä'),
            'audit_status': audit_data.get('audit_status', 'ok'),
            'notes': audit_data.get('notes', '')
        })
        
        # –Ø–≤–Ω–æ commit –≤—Å—ñ –∑–º—ñ–Ω–∏
        sys.stderr.write(f"[AUDIT] –í–∏–∫–ª–∏–∫–∞—î–º–æ db.commit()...\n")
        sys.stderr.flush()
        
        db.commit()
        
        sys.stderr.write(f"[AUDIT] ‚úÖ Committed successfully!\n")
        sys.stderr.flush()
        
        return {
            'success': True,
            'message': '–¢–ï–°–¢–û–í–ï –ü–û–í–Ü–î–û–ú–õ–ï–ù–ù–Ø –í–Ü–î –ù–û–í–û–ì–û –ö–û–î–£ 2025-11-13',
            'item_id': item_id,
            'audit_id': audit_id,
            'debug': '–ö–æ–¥ —Ç–æ—á–Ω–æ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è!'
        }
        
    except Exception as e:
        sys.stderr.write(f"[AUDIT] ‚ùå Error: {str(e)}\n")
        sys.stderr.flush()
        db.rollback()
        raise HTTPException(
            status_code=500,
            detail=f"–ü–æ–º–∏–ª–∫–∞: {str(e)}"
        )


@router.get("/stats")
async def get_audit_stats(
    db: Session = Depends(get_db)
):
    """
    –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–µ—Ä–µ–æ–±–ª—ñ–∫—É
    """
    try:
        # –ó–∞–≥–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ç–æ–≤–∞—Ä—ñ–≤
        total = db.query(func.count(OpenCartProduct.product_id)).filter(
            OpenCartProduct.status == 1
        ).scalar()
        
        # –ü–æ —Å—Ç–∞—Ç—É—Å–∞—Ö (–∑ inventory)
        stats_query = db.query(
            DecorInventoryItem.audit_status,
            func.count(DecorInventoryItem.id)
        ).group_by(DecorInventoryItem.audit_status).all()
        
        stats = {
            'total': total or 0,
            'ok': 0,
            'minor': 0,
            'crit': 0,
            'lost': 0,
            'overdueCnt': 0
        }
        
        for status, count in stats_query:
            if status == 'ok':
                stats['ok'] = count
            elif status == 'minor':
                stats['minor'] = count
            elif status == 'critical':
                stats['crit'] = count
            elif status == 'lost':
                stats['lost'] = count
        
        # Overdue (–±—ñ–ª—å—à–µ 180 –¥–Ω—ñ–≤)
        # TODO: —Å–∫–ª–∞–¥–Ω—ñ—à–∏–π query
        stats['overdueCnt'] = 0
        
        return stats
        
    except Exception as e:
        raise HTTPException(
            status_code=500,
            detail=f"–ü–æ–º–∏–ª–∫–∞: {str(e)}"
        )


@router.post("/calculate-lifecycle/{product_id}")
async def calculate_lifecycle_metrics(
    product_id: int,
    db: Session = Depends(get_db)
):
    """
    –ü—ñ–¥—Ä–∞—Ö—É–≤–∞—Ç–∏ lifecycle –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è —Ç–æ–≤–∞—Ä—É
    """
    try:
        from models_sqlalchemy import DecorProductLifecycle, DecorOrderItem, FinanceTransaction
        
        # 1. –†–∞—Ö—É—î–º–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –æ—Ä–µ–Ω–¥ —á–µ—Ä–µ–∑ DecorIssueCard
        rentals_count = db.query(func.count(DecorIssueCard.id)).filter(
            DecorIssueCard.status.in_(['issued', 'archived'])
        ).join(
            DecorOrder,
            DecorIssueCard.order_id == DecorOrder.id
        ).join(
            DecorOrderItem,
            DecorOrderItem.order_id == DecorOrder.id
        ).filter(
            DecorOrderItem.product_id == product_id
        ).scalar() or 0
        
        # 2. –†–∞—Ö—É—î–º–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ—à–∫–æ–¥–∂–µ–Ω—å –∑ decor_damages
        damages_count = db.query(func.count(DecorDamage.id)).join(
            DecorDamageItem,
            DecorDamageItem.damage_id == DecorDamage.id
        ).filter(
            DecorDamageItem.product_id == product_id
        ).scalar() or 0
        
        # 3. –†–∞—Ö—É—î–º–æ –∑–∞–≥–∞–ª—å–Ω–∏–π –ø—Ä–∏–±—É—Ç–æ–∫ –∑ —Ü—å–æ–≥–æ —Ç–æ–≤–∞—Ä—É
        # –°—É–º—É—î–º–æ rental —Å—É–º–∏ –∑ DecorOrderItem –¥–µ product_id –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î
        total_profit = db.query(func.sum(DecorOrderItem.total_rental)).filter(
            DecorOrderItem.product_id == product_id
        ).scalar() or 0
        
        # 4. –ó–Ω–∞—Ö–æ–¥–∏–º–æ –æ—Å—Ç–∞–Ω–Ω—î –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –∑ —Ü–∏–º —Ç–æ–≤–∞—Ä–æ–º
        last_order_item = db.query(DecorOrderItem).filter(
            DecorOrderItem.product_id == product_id
        ).order_by(DecorOrderItem.created_at.desc()).first()
        
        last_order_id = last_order_item.order_id if last_order_item else None
        
        # 5. –ó–±–µ—Ä—ñ–≥–∞—î–º–æ/–æ–Ω–æ–≤–ª—é—î–º–æ –≤ decor_product_lifecycle
        lifecycle = db.query(DecorProductLifecycle).filter(
            DecorProductLifecycle.product_id == product_id
        ).first()
        
        if lifecycle:
            # –û–Ω–æ–≤–ª—é—î–º–æ —ñ—Å–Ω—É—é—á–∏–π –∑–∞–ø–∏—Å
            lifecycle.rentals_count = rentals_count
            lifecycle.damages_count = damages_count
            lifecycle.total_profit = total_profit
            lifecycle.last_rental_order_id = last_order_id
            lifecycle.last_updated = datetime.now()
        else:
            # –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–∏–π –∑–∞–ø–∏—Å
            lifecycle = DecorProductLifecycle(
                product_id=product_id,
                rentals_count=rentals_count,
                damages_count=damages_count,
                total_profit=total_profit,
                last_rental_order_id=last_order_id
            )
            db.add(lifecycle)
        
        db.commit()
        
        return {
            'success': True,
            'product_id': product_id,
            'rentals_count': rentals_count,
            'damages_count': damages_count,
            'total_profit': float(total_profit),
            'last_order_id': last_order_id
        }
        
    except Exception as e:
        db.rollback()
        raise HTTPException(
            status_code=500,
            detail=f"–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥—Ä–∞—Ö—É–Ω–∫—É: {str(e)}"
        )


@router.put("/items/{item_id}/quantity")
async def update_quantity(
    item_id: str,
    data: dict,
    db: Session = Depends(get_db)
):
    """
    –û–Ω–æ–≤–∏—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ç–æ–≤–∞—Ä—É
    """
    try:
        product_id = int(item_id.replace('A-', ''))
        new_qty = data.get('qty')
        
        if new_qty is None or new_qty < 0:
            raise HTTPException(status_code=400, detail="–ù–µ–≤—ñ—Ä–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å")
        
        product = db.query(OpenCartProduct).filter(
            OpenCartProduct.product_id == product_id
        ).first()
        
        if not product:
            raise HTTPException(status_code=404, detail="–¢–æ–≤–∞—Ä –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ")
        
        old_qty = product.quantity
        product.quantity = new_qty
        
        # –°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–ø–∏—Å –≤ —ñ—Å—Ç–æ—Ä—ñ—ó
        history = DecorProductHistory(
            id=f"H-{uuid.uuid4().hex[:8].upper()}",
            product_id=product_id,
            event_type='edited',
            actor=data.get('actor', '–†–µ–∫–≤—ñ–∑–∏—Ç–æ—Ä'),
            notes=f"–ö—ñ–ª—å–∫—ñ—Å—Ç—å –∑–º—ñ–Ω–µ–Ω–æ –∑ {old_qty} –Ω–∞ {new_qty}"
        )
        db.add(history)
        
        db.commit()
        
        return {
            'success': True,
            'product_id': product_id,
            'old_qty': old_qty,
            'new_qty': new_qty
        }
        
    except HTTPException:
        raise
    except Exception as e:
        db.rollback()
        raise HTTPException(status_code=500, detail=f"–ü–æ–º–∏–ª–∫–∞: {str(e)}")


@router.put("/items/{item_id}/location")
async def update_location(
    item_id: str,
    data: dict,
    db: Session = Depends(get_db)
):
    """
    –û–Ω–æ–≤–∏—Ç–∏ –ª–æ–∫–∞—Ü—ñ—é —Ç–æ–≤–∞—Ä—É
    """
    try:
        product_id = int(item_id.replace('A-', ''))
        
        zone = data.get('zone')
        location = data.get('location')
        
        # –û–Ω–æ–≤–∏—Ç–∏ –≤ catalog
        catalog = db.query(DecorProductCatalog).filter(
            DecorProductCatalog.product_id == product_id
        ).first()
        
        if not catalog:
            catalog = DecorProductCatalog(product_id=product_id)
            db.add(catalog)
        
        if zone:
            catalog.location_zone = zone
        if location:
            # Parse location (–Ω–∞–ø—Ä. "6A12")
            catalog.location_aisle = location[:2] if len(location) >= 2 else location
            catalog.location_shelf = location[2:] if len(location) > 2 else None
        
        # –Ü—Å—Ç–æ—Ä—ñ—è
        history = DecorProductHistory(
            id=f"H-{uuid.uuid4().hex[:8].upper()}",
            product_id=product_id,
            event_type='moved',
            actor=data.get('actor', '–†–µ–∫–≤—ñ–∑–∏—Ç–æ—Ä'),
            notes=f"–ü–µ—Ä–µ–º—ñ—â–µ–Ω–æ –≤ {zone} ¬∑ {location}"
        )
        db.add(history)
        
        db.commit()
        
        return {
            'success': True,
            'product_id': product_id,
            'zone': zone,
            'location': location
        }
        
    except Exception as e:
        db.rollback()
        raise HTTPException(status_code=500, detail=f"–ü–æ–º–∏–ª–∫–∞: {str(e)}")


@router.put("/items/{item_id}/status")
async def update_audit_status(
    item_id: str,
    data: dict,
    db: Session = Depends(get_db)
):
    """
    –û–Ω–æ–≤–∏—Ç–∏ audit status —Ç–æ–≤–∞—Ä—É
    """
    try:
        product_id = int(item_id.replace('A-', ''))
        new_status = data.get('status')
        
        if new_status not in ['ok', 'minor', 'critical', 'lost']:
            raise HTTPException(status_code=400, detail="–ù–µ–≤—ñ—Ä–Ω–∏–π —Å—Ç–∞—Ç—É—Å")
        
        # –û–Ω–æ–≤–∏—Ç–∏ –≤ inventory
        inventory = db.query(DecorInventoryItem).filter(
            DecorInventoryItem.product_id == product_id
        ).first()
        
        if not inventory:
            inventory = DecorInventoryItem(
                id=f"INV-{uuid.uuid4().hex[:8].upper()}",
                product_id=product_id,
                inventory_code=f"AUTO-{product_id}",
                status='available'
            )
            db.add(inventory)
        
        old_status = inventory.audit_status
        inventory.audit_status = new_status
        
        # –Ü—Å—Ç–æ—Ä—ñ—è
        history = DecorProductHistory(
            id=f"H-{uuid.uuid4().hex[:8].upper()}",
            product_id=product_id,
            event_type='edited',
            actor=data.get('actor', '–†–µ–∫–≤—ñ–∑–∏—Ç–æ—Ä'),
            notes=f"–°—Ç–∞—Ç—É—Å –∑–º—ñ–Ω–µ–Ω–æ –∑ {old_status} –Ω–∞ {new_status}"
        )
        db.add(history)
        
        db.commit()
        
        return {
            'success': True,
            'product_id': product_id,
            'old_status': old_status,
            'new_status': new_status
        }
        
    except Exception as e:
        db.rollback()
        raise HTTPException(status_code=500, detail=f"–ü–æ–º–∏–ª–∫–∞: {str(e)}")


@router.put("/items/{item_id}/notes")
async def update_notes(
    item_id: str,
    data: dict,
    db: Session = Depends(get_db)
):
    """
    –û–Ω–æ–≤–∏—Ç–∏ –Ω–æ—Ç–∞—Ç–∫–∏
    """
    try:
        product_id = int(item_id.replace('A-', ''))
        notes = data.get('notes', '')
        
        inventory = db.query(DecorInventoryItem).filter(
            DecorInventoryItem.product_id == product_id
        ).first()
        
        if not inventory:
            inventory = DecorInventoryItem(
                id=f"INV-{uuid.uuid4().hex[:8].upper()}",
                product_id=product_id,
                inventory_code=f"AUTO-{product_id}",
                status='available'
            )
            db.add(inventory)
        
        inventory.audit_notes = notes
        
        db.commit()
        
        return {
            'success': True,
            'product_id': product_id
        }
        
    except Exception as e:
        db.rollback()
        raise HTTPException(status_code=500, detail=f"–ü–æ–º–∏–ª–∫–∞: {str(e)}")


@router.get("/items/{item_id}/history")
async def get_product_history(
    item_id: str,
    db: Session = Depends(get_db)
):
    """
    –û—Ç—Ä–∏–º–∞—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é —Ç–æ–≤–∞—Ä—É
    """
    try:
        product_id = int(item_id.replace('A-', ''))
        
        history_items = db.query(DecorProductHistory).filter(
            DecorProductHistory.product_id == product_id
        ).order_by(DecorProductHistory.created_at.desc()).limit(50).all()
        
        history_list = []
        for h in history_items:
            history_list.append({
                'id': h.id,
                'date': h.created_at.isoformat() if h.created_at else None,
                'kind': h.event_type,
                'actor': h.actor or '–°–∏—Å—Ç–µ–º–∞',
                'orderId': h.order_id,
                'note': h.notes or ''
            })
        
        return history_list
        
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"–ü–æ–º–∏–ª–∫–∞: {str(e)}")


@router.get("/items/{item_id}/rental-history")
async def get_rental_history(
    item_id: str,
    db: Session = Depends(get_db)
):
    """
    –û—Ç—Ä–∏–º–∞—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é –æ—Ä–µ–Ω–¥ —Ç–æ–≤–∞—Ä—É –∑ OpenCart —Ç–∞–±–ª–∏—Ü—å
    """
    try:
        product_id = int(item_id.replace('A-', ''))
        
        # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ OpenCart —Ç–∞–±–ª–∏—Ü—ñ: oc_order, oc_order_product
        query = text("""
            SELECT 
                o.order_id,
                o.invoice_no as order_number,
                CONCAT(o.firstname, ' ', o.lastname) as client_name,
                o.telephone as client_phone,
                o.date_added as rent_date,
                o.date_modified as rent_return_date,
                DATEDIFF(o.date_modified, o.date_added) as rental_days,
                op.quantity,
                op.total as total_rental,
                o.payment_method,
                o.order_status_id,
                o.date_added as created_at
            FROM oc_order_product op
            INNER JOIN oc_order o ON op.order_id = o.order_id
            WHERE op.product_id = :product_id
            ORDER BY o.date_added DESC
            LIMIT 50
        """)
        
        result = db.execute(query, {"product_id": product_id})
        rows = result.fetchall()
        
        rental_history = []
        for row in rows:
            # –ö–æ–Ω–≤–µ—Ä—Ç—É–≤–∞—Ç–∏ –¥–∞—Ç–∏ –≤ ISO —Ñ–æ—Ä–º–∞—Ç —è–∫—â–æ –≤–æ–Ω–∏ —î
            rent_date = row[4].isoformat() if hasattr(row[4], 'isoformat') else str(row[4]) if row[4] else None
            rent_return_date = row[5].isoformat() if hasattr(row[5], 'isoformat') else str(row[5]) if row[5] else None
            created_at = row[11].isoformat() if hasattr(row[11], 'isoformat') else str(row[11]) if row[11] else None
            
            # Mapping order_status_id to status name
            status_map = {
                1: '–û—á—ñ–∫—É—î',
                2: '–í –æ–±—Ä–æ–±—Ü—ñ',
                3: '–í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ',
                5: '–ó–∞–≤–µ—Ä—à–µ–Ω–æ',
                7: '–°–∫–∞—Å–æ–≤–∞–Ω–æ'
            }
            status_name = status_map.get(row[10], '–ù–µ–≤—ñ–¥–æ–º–æ')
            
            rental_history.append({
                'order_id': row[0],
                'order_number': f"#{row[1]}" if row[1] else f"#{row[0]}",
                'client_name': row[2] or '–ö–ª—ñ—î–Ω—Ç –Ω–µ –≤–∫–∞–∑–∞–Ω–∏–π',
                'client_phone': row[3] or '',
                'rent_date': rent_date,
                'rent_return_date': rent_return_date,
                'rental_days': row[6] or 1,
                'quantity': row[7],
                'total_rental': float(row[8]) if row[8] else 0.0,
                'deposit': 0.0,  # TODO: –∑–Ω–∞–π—Ç–∏ –¥–µ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –∑–∞—Å—Ç–∞–≤–∞ –≤ OpenCart
                'status': status_name,
                'created_at': created_at
            })
        
        return rental_history
        
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"–ü–æ–º–∏–ª–∫–∞: {str(e)}")


@router.get("/items/{item_id}/audit-history")
async def get_audit_history(
    item_id: str,
    db: Session = Depends(get_db)
):
    """
    –û—Ç—Ä–∏–º–∞—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é –ø–µ—Ä–µ–æ–±–ª—ñ–∫—ñ–≤ —Ç–æ–≤–∞—Ä—É
    """
    try:
        product_id = int(item_id.replace('A-', ''))
        
        query = text("""
            SELECT 
                id,
                audit_date,
                audited_by,
                audit_status,
                audit_notes,
                created_at
            FROM decor_product_audits
            WHERE product_id = :product_id
            ORDER BY audit_date DESC, created_at DESC
            LIMIT 50
        """)
        
        result = db.execute(query, {"product_id": product_id})
        rows = result.fetchall()
        
        audit_history = []
        for row in rows:
            audit_date = row[1].isoformat() if hasattr(row[1], 'isoformat') else str(row[1])
            created_at = row[5].isoformat() if hasattr(row[5], 'isoformat') else str(row[5])
            
            audit_history.append({
                'id': row[0],
                'audit_date': audit_date,
                'audited_by': row[2] or '–ù–µ–≤—ñ–¥–æ–º–æ',
                'audit_status': row[3] or 'ok',
                'audit_notes': row[4] or '',
                'created_at': created_at
            })
        
        return audit_history
        
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"–ü–æ–º–∏–ª–∫–∞: {str(e)}")


# ============================================================
# ACTION BUTTON ENDPOINTS



@router.put("/items/{item_id}/edit-full")
async def edit_item_full(
    item_id: str,
    data: dict,
    db: Session = Depends(get_db)
):
    """
    –ü–æ–≤–Ω–µ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Ç–æ–≤–∞—Ä—É: –Ω–∞–∑–≤–∞, –∫–æ–ª—ñ—Ä, –º–∞—Ç–µ—Ä—ñ–∞–ª, –∫—ñ–ª—å–∫—ñ—Å—Ç—å, —Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è
    –û–Ω–æ–≤–ª—é—î –¥–∞–Ω—ñ –≤ OpenCart –∞—Ç—Ä–∏–±—É—Ç–∞—Ö + –Ω–æ–≤—ñ —Ç–∞–±–ª–∏—Ü—ñ
    """
    try:
        product_id = int(item_id.replace('A-', ''))
        changes = []
        
        # 1. –û–Ω–æ–≤–∏—Ç–∏ –Ω–∞–∑–≤—É –≤ oc_product_description
        if 'name' in data and data['name']:
            description = db.query(OpenCartProductDescription).filter(
                OpenCartProductDescription.product_id == product_id,
                OpenCartProductDescription.language_id == 4
            ).first()
            if description:
                old_name = description.name
                description.name = data['name']
                changes.append(f"–ù–∞–∑–≤–∞: '{old_name}' ‚Üí '{data['name']}'")
        
        # 1.5 –û–Ω–æ–≤–∏—Ç–∏ –∫–æ–¥ (SKU) –≤ oc_product
        if 'code' in data and data['code']:
            product = db.query(OpenCartProduct).filter(
                OpenCartProduct.product_id == product_id
            ).first()
            if product:
                old_code = product.model
                product.model = data['code']
                changes.append(f"–ö–æ–¥: '{old_code}' ‚Üí '{data['code']}'")
        
        # 2. –û–Ω–æ–≤–∏—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≤ oc_product
        if 'qty' in data and data['qty'] is not None:
            product = db.query(OpenCartProduct).filter(
                OpenCartProduct.product_id == product_id
            ).first()
            if product:
                old_qty = product.quantity
                product.quantity = data['qty']
                changes.append(f"–ö—ñ–ª—å–∫—ñ—Å—Ç—å: {old_qty} ‚Üí {data['qty']}")
        
        # 3. –û–Ω–æ–≤–∏—Ç–∏ –ö–û–õ–Ü–† –≤ OpenCart –∞—Ç—Ä–∏–±—É—Ç–∞—Ö (attribute_id = 13)
        if 'color' in data:
            # –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ —ñ—Å–Ω—É—î –∞—Ç—Ä–∏–±—É—Ç
            color_attr_query = text("""
                SELECT product_id FROM oc_product_attribute 
                WHERE product_id = :pid AND attribute_id = 13 AND language_id = 4
            """)
            color_exists = db.execute(color_attr_query, {"pid": product_id}).fetchone()
            
            if color_exists:
                # –û–Ω–æ–≤–∏—Ç–∏
                db.execute(text("""
                    UPDATE oc_product_attribute 
                    SET text = :color
                    WHERE product_id = :pid AND attribute_id = 13 AND language_id = 4
                """), {"color": data['color'], "pid": product_id})
            else:
                # –°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–∏–π –∞—Ç—Ä–∏–±—É—Ç
                db.execute(text("""
                    INSERT INTO oc_product_attribute (product_id, attribute_id, language_id, text)
                    VALUES (:pid, 13, 4, :color)
                """), {"pid": product_id, "color": data['color']})
            
            changes.append(f"–ö–æ–ª—ñ—Ä: {data['color']}")
        
        # 4. –û–Ω–æ–≤–∏—Ç–∏ –ú–ê–¢–ï–†–Ü–ê–õ –≤ OpenCart –∞—Ç—Ä–∏–±—É—Ç–∞—Ö (attribute_id = 16)
        if 'material' in data:
            # –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ —ñ—Å–Ω—É—î –∞—Ç—Ä–∏–±—É—Ç
            material_attr_query = text("""
                SELECT product_id FROM oc_product_attribute 
                WHERE product_id = :pid AND attribute_id = 16 AND language_id = 4
            """)
            material_exists = db.execute(material_attr_query, {"pid": product_id}).fetchone()
            
            if material_exists:
                # –û–Ω–æ–≤–∏—Ç–∏
                db.execute(text("""
                    UPDATE oc_product_attribute 
                    SET text = :material
                    WHERE product_id = :pid AND attribute_id = 16 AND language_id = 4
                """), {"material": data['material'], "pid": product_id})
            else:
                # –°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–∏–π –∞—Ç—Ä–∏–±—É—Ç
                db.execute(text("""
                    INSERT INTO oc_product_attribute (product_id, attribute_id, language_id, text)
                    VALUES (:pid, 16, 4, :material)
                """), {"pid": product_id, "material": data['material']})
            
            changes.append(f"–ú–∞—Ç–µ—Ä—ñ–∞–ª: {data['material']}")
        
        # 4.5 –û–Ω–æ–≤–∏—Ç–∏ —Ä–æ–∑–º—ñ—Ä, –∫–æ–ª—ñ—Ä, –º–∞—Ç–µ—Ä—ñ–∞–ª –≤ decor_product_extended (—Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è)
        # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –ø–æ—Ç—Ä—ñ–±–Ω–æ –æ–Ω–æ–≤–∏—Ç–∏ extended —Ç–∞–±–ª–∏—Ü—é
        if 'size' in data or 'color' in data or 'material' in data:
            extended = db.query(DecorProductExtended).filter(
                DecorProductExtended.product_id == product_id
            ).first()
            
            if not extended:
                # –°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–∏–π –∑–∞–ø–∏—Å —è–∫—â–æ –Ω–µ —ñ—Å–Ω—É—î
                extended = DecorProductExtended(
                    product_id=product_id,
                    created_at=datetime.now(),
                    updated_at=datetime.now()
                )
                db.add(extended)
                db.flush()  # –û—Ç—Ä–∏–º–∞—Ç–∏ ID
            
            # –û–Ω–æ–≤–∏—Ç–∏ –ø–æ–ª—è
            if 'size' in data:
                extended.size = data['size']
                changes.append(f"–†–æ–∑–º—ñ—Ä: {data['size']}")
            if 'color' in data:
                extended.color = data['color']
            if 'material' in data:
                extended.material = data['material']
            
            extended.updated_at = datetime.now()
        
        # 5. –û–Ω–æ–≤–∏—Ç–∏ —Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è
        if 'zone' in data or 'location' in data:
            catalog = db.query(DecorProductCatalog).filter(
                DecorProductCatalog.product_id == product_id
            ).first()
            if not catalog:
                catalog = DecorProductCatalog(product_id=product_id, created_at=datetime.now())
                db.add(catalog)
            
            if 'zone' in data and data['zone']:
                catalog.location_zone = data['zone']
                changes.append(f"–ó–æ–Ω–∞: {data['zone']}")
            if 'location' in data and data['location']:
                location = data['location']
                # –ü–∞—Ä—Å–∏–Ω–≥ –ª–æ–∫–∞—Ü—ñ—ó (–Ω–∞–ø—Ä. "6A12" -> aisle=6A, shelf=12)
                import re
                match = re.match(r'(\d+[A-Z]+)(\d+)', location)
                if match:
                    catalog.location_aisle = match.group(1)
                    catalog.location_shelf = match.group(2)
                else:
                    catalog.location_aisle = location
                changes.append(f"–õ–æ–∫–∞—Ü—ñ—è: {location}")
        
        # 6. –û–Ω–æ–≤–∏—Ç–∏ –Ω–æ—Ç–∞—Ç–∫–∏
        if 'notes' in data:
            inventory = db.query(DecorInventoryItem).filter(
                DecorInventoryItem.product_id == product_id
            ).first()
            if not inventory:
                inventory = DecorInventoryItem(
                    id=f"INV-{uuid.uuid4().hex[:8].upper()}",
                    product_id=product_id,
                    inventory_code=f"AUTO-{product_id}",
                    status='available'
                )
                db.add(inventory)
            
            inventory.audit_notes = data['notes']
            changes.append("–ù–æ—Ç–∞—Ç–∫–∏ –æ–Ω–æ–≤–ª–µ–Ω–æ")
        
        # 7. –ó–∞–ø–∏—Å–∞—Ç–∏ –≤ —ñ—Å—Ç–æ—Ä—ñ—é
        if changes:
            history = DecorProductHistory(
                id=f"H-{uuid.uuid4().hex[:8].upper()}",
                product_id=product_id,
                event_type='edited',
                actor=data.get('actor', '–†–µ–∫–≤—ñ–∑–∏—Ç–æ—Ä'),
                notes=f"–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –∫–∞—Ä—Ç–∫–∏: {', '.join(changes)}"
            )
            db.add(history)
        
        db.commit()
        
        return {
            'success': True,
            'product_id': product_id,
            'changes': changes,
            'message': '–î–∞–Ω—ñ –æ–Ω–æ–≤–ª–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ'
        }
        
    except Exception as e:
        db.rollback()
        raise HTTPException(status_code=500, detail=f"–ü–æ–º–∏–ª–∫–∞: {str(e)}")

# ============================================================

@router.post("/items/{item_id}/send-to-wash")
async def send_to_wash(
    item_id: str,
    data: dict,
    db: Session = Depends(get_db)
):
    """
    –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ —Ç–æ–≤–∞—Ä –Ω–∞ –º–∏–π–∫—É
    """
    try:
        product_id = int(item_id.replace('A-', ''))
        
        # –û–Ω–æ–≤–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å –≤ –∫–∞—Ç–∞–ª–æ–∑—ñ
        catalog = db.query(DecorProductCatalog).filter(
            DecorProductCatalog.product_id == product_id
        ).first()
        
        if not catalog:
            catalog = DecorProductCatalog(product_id=product_id)
            db.add(catalog)
        
        catalog.cleaning_status = 'wash'
        catalog.cleaning_last_updated = datetime.now()
        
        # –û–Ω–æ–≤–∏—Ç–∏ inventory status
        inventory = db.query(DecorInventoryItem).filter(
            DecorInventoryItem.product_id == product_id
        ).first()
        
        if inventory:
            inventory.status = 'washing'
        
        # –Ü—Å—Ç–æ—Ä—ñ—è
        history = DecorProductHistory(
            id=f"H-{uuid.uuid4().hex[:8].upper()}",
            product_id=product_id,
            event_type='cleaning',
            actor=data.get('actor', '–†–µ–∫–≤—ñ–∑–∏—Ç–æ—Ä'),
            notes=f"–í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –º–∏–π–∫—É: {data.get('notes', '')}"
        )
        db.add(history)
        
        db.commit()
        
        return {
            'success': True,
            'product_id': product_id,
            'message': '–¢–æ–≤–∞—Ä –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –º–∏–π–∫—É'
        }
        
    except Exception as e:
        db.rollback()
        raise HTTPException(status_code=500, detail=f"–ü–æ–º–∏–ª–∫–∞: {str(e)}")


@router.post("/items/{item_id}/add-damage")
async def add_damage_during_audit(
    item_id: str,
    data: dict,
    db: Session = Depends(get_db)
):
    """
    –ó–∞—Ñ—ñ–∫—Å—É–≤–∞—Ç–∏ –ø–æ—à–∫–æ–¥–∂–µ–Ω–Ω—è –ø—Ä–∏ –ø–µ—Ä–µ–æ–±–ª—ñ–∫—É
    """
    try:
        product_id = int(item_id.replace('A-', ''))
        
        # –û—Ç—Ä–∏–º–∞—Ç–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ —Ç–æ–≤–∞—Ä
        product = db.query(OpenCartProduct).filter(
            OpenCartProduct.product_id == product_id
        ).first()
        
        if not product:
            raise HTTPException(status_code=404, detail="–¢–æ–≤–∞—Ä –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ")
        
        description = db.query(OpenCartProductDescription).filter(
            OpenCartProductDescription.product_id == product_id,
            OpenCartProductDescription.language_id == 4
        ).first()
        
        # –ó–Ω–∞–π—Ç–∏ –æ—Å—Ç–∞–Ω–Ω—î –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è (—è–∫—â–æ —î)
        inventory = db.query(DecorInventoryItem).filter(
            DecorInventoryItem.product_id == product_id
        ).first()
        
        order_id = inventory.last_order_id if inventory and inventory.last_order_id else None
        
        # –°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–ø–∏—Å –ø–æ—à–∫–æ–¥–∂–µ–Ω–Ω—è –≤ —ñ—Å—Ç–æ—Ä—ñ—ó
        damage_type = data.get('damage_type', 'physical')
        damage_description = data.get('description', '')
        severity = data.get('severity', 'minor')  # minor, critical
        photo_url = data.get('photo_url', '')
        
        # –ó–∞–ø–∏—Å–∞—Ç–∏ –≤ —ñ—Å—Ç–æ—Ä—ñ—é —Ç–æ–≤–∞—Ä—É –∑ —Ñ–æ—Ç–æ
        history_id = f"H-{uuid.uuid4().hex[:8].upper()}"
        
        db.execute(text("""
            INSERT INTO decor_product_history 
            (id, product_id, event_type, actor, order_id, notes, photo_url, created_at)
            VALUES (:id, :product_id, 'damage_opened', :actor, :order_id, :notes, :photo_url, NOW())
        """), {
            'id': history_id,
            'product_id': product_id,
            'actor': data.get('actor', '–†–µ–∫–≤—ñ–∑–∏—Ç–æ—Ä'),
            'order_id': order_id,
            'notes': f"–ü–æ—à–∫–æ–¥–∂–µ–Ω–Ω—è ({severity}): {damage_description}",
            'photo_url': photo_url
        })
        
        # –û–Ω–æ–≤–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å inventory —è–∫—â–æ –ø–æ—à–∫–æ–¥–∂–µ–Ω–Ω—è –∫—Ä–∏—Ç–∏—á–Ω–µ
        if inventory:
            if severity == 'critical':
                inventory.audit_status = 'critical'
            elif severity == 'minor' and inventory.audit_status != 'critical':
                inventory.audit_status = 'minor'
            
            # –î–æ–¥–∞—Ç–∏ –Ω–æ—Ç–∞—Ç–∫—É –ø—Ä–æ –ø–æ—à–∫–æ–¥–∂–µ–Ω–Ω—è
            current_notes = inventory.audit_notes or ''
            damage_note = f"\n[{datetime.now().strftime('%Y-%m-%d')}] –ü–æ—à–∫–æ–¥–∂–µ–Ω–Ω—è: {damage_description}"
            inventory.audit_notes = (current_notes + damage_note)[:500]  # –û–±–º–µ–∂–µ–Ω–Ω—è 500 —Å–∏–º–≤–æ–ª—ñ–≤
        
        # –Ø–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –ø–æ–≤–Ω–∏–π –∫–µ–π—Å –ø–æ—à–∫–æ–¥–∂–µ–Ω–Ω—è
        if data.get('create_damage_case', False):
            damage_id = f"DMG-{uuid.uuid4().hex[:8].upper()}"
            damage = DecorDamage(
                id=damage_id,
                order_id=order_id,
                order_number=f"AUDIT-{product_id}",
                customer_id=0,
                customer_name="–ü–µ—Ä–µ–æ–±–ª—ñ–∫",
                case_status='draft',
                finance_status='none',
                fulfillment_status='none',
                claimed_total=float(data.get('estimated_cost', 0)),
                notes=damage_description,
                created_by=data.get('actor', '–†–µ–∫–≤—ñ–∑–∏—Ç–æ—Ä')
            )
            db.add(damage)
            
            # –î–æ–¥–∞—Ç–∏ item –≤ –∫–µ–π—Å
            damage_item = DecorDamageItem(
                damage_id=damage_id,
                product_id=product_id,
                barcode=product.model,
                name=description.name if description else product.model,
                image=product.image,
                damage_type=damage_type,
                qty=1,
                base_value=float(product.ean) if product.ean else 0,
                estimate_value=float(data.get('estimated_cost', 0)),
                resolution='pending',
                comment=damage_description
            )
            db.add(damage_item)
        
        db.commit()
        
        return {
            'success': True,
            'product_id': product_id,
            'message': '–ü–æ—à–∫–æ–¥–∂–µ–Ω–Ω—è –∑–∞—Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ',
            'severity': severity
        }
        
    except HTTPException:
        raise
    except Exception as e:
        db.rollback()
        raise HTTPException(status_code=500, detail=f"–ü–æ–º–∏–ª–∫–∞: {str(e)}")


@router.get("/items/{item_id}/damages")
async def get_item_damages(
    item_id: str,
    db: Session = Depends(get_db)
):
    """
    –û—Ç—Ä–∏–º–∞—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é –ø–æ—à–∫–æ–¥–∂–µ–Ω—å —Ç–æ–≤–∞—Ä—É
    """
    try:
        product_id = int(item_id.replace('A-', ''))
        
        # –û—Ç—Ä–∏–º–∞—Ç–∏ –≤—Å—ñ –∑–∞–ø–∏—Å–∏ –ø—Ä–æ –ø–æ—à–∫–æ–¥–∂–µ–Ω–Ω—è –∑ —ñ—Å—Ç–æ—Ä—ñ—ó –≤–∫–ª—é—á–∞—é—á–∏ —Ñ–æ—Ç–æ
        result = db.execute(text("""
            SELECT id, created_at, actor, notes, order_id, photo_url
            FROM decor_product_history
            WHERE product_id = :pid 
            AND event_type IN ('damage_noted', 'damage_opened')
            ORDER BY created_at DESC
        """), {'pid': product_id})
        
        damage_list = []
        for row in result:
            damage_list.append({
                'id': row[0],
                'date': row[1].isoformat() if row[1] else None,
                'actor': row[2] or '–°–∏—Å—Ç–µ–º–∞',
                'notes': row[3],
                'order_id': row[4],
                'photo_url': row[5]
            })
        
        return damage_list
        
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"–ü–æ–º–∏–ª–∫–∞: {str(e)}")


@router.post("/items/{item_id}/send-to-restoration")
async def send_to_restoration(
    item_id: str,
    data: dict,
    db: Session = Depends(get_db)
):
    """
    –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ —Ç–æ–≤–∞—Ä –Ω–∞ —Ä–µ—Å—Ç–∞–≤—Ä–∞—Ü—ñ—é
    """
    try:
        product_id = int(item_id.replace('A-', ''))
        
        # –û–Ω–æ–≤–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å –≤ –∫–∞—Ç–∞–ª–æ–∑—ñ
        catalog = db.query(DecorProductCatalog).filter(
            DecorProductCatalog.product_id == product_id
        ).first()
        
        if not catalog:
            catalog = DecorProductCatalog(product_id=product_id)
            db.add(catalog)
        
        catalog.cleaning_status = 'repair'
        catalog.product_state = 'damaged'
        catalog.cleaning_last_updated = datetime.now()
        
        # –û–Ω–æ–≤–∏—Ç–∏ inventory status
        inventory = db.query(DecorInventoryItem).filter(
            DecorInventoryItem.product_id == product_id
        ).first()
        
        if inventory:
            inventory.status = 'repair'
            inventory.audit_status = 'minor'
        
        # –Ü—Å—Ç–æ—Ä—ñ—è
        history = DecorProductHistory(
            id=f"H-{uuid.uuid4().hex[:8].upper()}",
            product_id=product_id,
            event_type='repair',
            actor=data.get('actor', '–†–µ–∫–≤—ñ–∑–∏—Ç–æ—Ä'),
            notes=f"–í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ —Ä–µ—Å—Ç–∞–≤—Ä–∞—Ü—ñ—é: {data.get('notes', '')}"
        )
        db.add(history)
        
        db.commit()
        
        return {
            'success': True,
            'product_id': product_id,
            'message': '–¢–æ–≤–∞—Ä –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ —Ä–µ—Å—Ç–∞–≤—Ä–∞—Ü—ñ—é'
        }
        
    except Exception as e:
        db.rollback()
        raise HTTPException(status_code=500, detail=f"–ü–æ–º–∏–ª–∫–∞: {str(e)}")


@router.post("/items/{item_id}/create-damage-case")
async def create_damage_case(
    item_id: str,
    data: dict,
    db: Session = Depends(get_db)
):
    """
    –°—Ç–≤–æ—Ä–∏—Ç–∏ –∫–µ–π—Å –ø–æ—à–∫–æ–¥–∂–µ–Ω–Ω—è
    """
    try:
        product_id = int(item_id.replace('A-', ''))
        
        # –û—Ç—Ä–∏–º–∞—Ç–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ —Ç–æ–≤–∞—Ä
        product = db.query(OpenCartProduct).filter(
            OpenCartProduct.product_id == product_id
        ).first()
        
        if not product:
            raise HTTPException(status_code=404, detail="–¢–æ–≤–∞—Ä –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ")
        
        description = db.query(OpenCartProductDescription).filter(
            OpenCartProductDescription.product_id == product_id,
            OpenCartProductDescription.language_id == 4
        ).first()
        
        # –ó–Ω–∞–π—Ç–∏ –æ—Å—Ç–∞–Ω–Ω—î –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –∑ —Ü–∏–º —Ç–æ–≤–∞—Ä–æ–º
        inventory = db.query(DecorInventoryItem).filter(
            DecorInventoryItem.product_id == product_id
        ).first()
        
        order_id = inventory.last_order_id if inventory and inventory.last_order_id else None
        
        # –°—Ç–≤–æ—Ä–∏—Ç–∏ –∫–µ–π—Å –ø–æ—à–∫–æ–¥–∂–µ–Ω–Ω—è
        damage_id = f"DMG-{uuid.uuid4().hex[:8].upper()}"
        damage = DecorDamage(
            id=damage_id,
            order_id=order_id,
            order_number=f"ORDER-{order_id}" if order_id else "AUDIT",
            customer_id=0,
            customer_name="–ê—É–¥–∏—Ç",
            case_status='draft',
            finance_status='none',
            fulfillment_status='none',
            claimed_total=float(data.get('damage_cost', 0)),
            notes=data.get('notes', '–°—Ç–≤–æ—Ä–µ–Ω–æ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–æ–±–ª—ñ–∫'),
            created_by=data.get('actor', '–†–µ–∫–≤—ñ–∑–∏—Ç–æ—Ä')
        )
        db.add(damage)
        
        # –°—Ç–≤–æ—Ä–∏—Ç–∏ item –≤ –∫–µ–π—Å—ñ
        damage_item = DecorDamageItem(
            damage_id=damage_id,
            product_id=product_id,
            barcode=product.model,
            name=description.name if description else product.model,
            image=product.image,
            damage_type=data.get('damage_type', 'physical'),
            qty=1,
            base_value=float(product.ean) if product.ean else 0,
            estimate_value=float(data.get('damage_cost', 0)),
            resolution='pending',
            comment=data.get('notes', '')
        )
        db.add(damage_item)
        
        # –û–Ω–æ–≤–∏—Ç–∏ inventory status
        if inventory:
            inventory.audit_status = 'critical'
            inventory.status = 'repair'
        
        # –Ü—Å—Ç–æ—Ä—ñ—è
        history = DecorProductHistory(
            id=f"H-{uuid.uuid4().hex[:8].upper()}",
            product_id=product_id,
            event_type='damage_opened',
            actor=data.get('actor', '–†–µ–∫–≤—ñ–∑–∏—Ç–æ—Ä'),
            order_id=order_id,
            notes=f"–í—ñ–¥–∫—Ä–∏—Ç–æ –∫–µ–π—Å –ø–æ—à–∫–æ–¥–∂–µ–Ω–Ω—è: {damage_id}"
        )
        db.add(history)
        
        db.commit()
        
        return {
            'success': True,
            'product_id': product_id,
            'damage_id': damage_id,
            'message': '–ö–µ–π—Å –ø–æ—à–∫–æ–¥–∂–µ–Ω–Ω—è —Å—Ç–≤–æ—Ä–µ–Ω–æ'
        }
        
    except HTTPException:
        raise
    except Exception as e:
        db.rollback()
        raise HTTPException(status_code=500, detail=f"–ü–æ–º–∏–ª–∫–∞: {str(e)}")


@router.put("/items/{item_id}/edit-all")
async def edit_all_item_data(
    item_id: str,
    data: dict,
    db: Session = Depends(get_db)
):
    """
    –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –≤—Å—ñ –¥–∞–Ω—ñ —Ç–æ–≤–∞—Ä—É –æ–¥–Ω–∏–º –∑–∞–ø–∏—Ç–æ–º
    """
    try:
        product_id = int(item_id.replace('A-', ''))
        changes = []
        
        # –û–Ω–æ–≤–∏—Ç–∏ –Ω–∞–∑–≤—É
        if 'name' in data:
            description = db.query(OpenCartProductDescription).filter(
                OpenCartProductDescription.product_id == product_id,
                OpenCartProductDescription.language_id == 4
            ).first()
            if description:
                old_name = description.name
                description.name = data['name']
                changes.append(f"–ù–∞–∑–≤–∞: '{old_name}' ‚Üí '{data['name']}'")
        
        # –û–Ω–æ–≤–∏—Ç–∏ –∫—ñ–ª—å–∫—ñ—Å—Ç—å
        if 'qty' in data:
            product = db.query(OpenCartProduct).filter(
                OpenCartProduct.product_id == product_id
            ).first()
            if product:
                old_qty = product.quantity
                product.quantity = data['qty']
                changes.append(f"–ö—ñ–ª—å–∫—ñ—Å—Ç—å: {old_qty} ‚Üí {data['qty']}")
        
        # –û–Ω–æ–≤–∏—Ç–∏ –ª–æ–∫–∞—Ü—ñ—é
        if 'zone' in data or 'location' in data:
            catalog = db.query(DecorProductCatalog).filter(
                DecorProductCatalog.product_id == product_id
            ).first()
            if not catalog:
                catalog = DecorProductCatalog(product_id=product_id)
                db.add(catalog)
            
            if 'zone' in data:
                catalog.location_zone = data['zone']
                changes.append(f"–ó–æ–Ω–∞: {data['zone']}")
            if 'location' in data:
                location = data['location']
                catalog.location_aisle = location[:2] if len(location) >= 2 else location
                catalog.location_shelf = location[2:] if len(location) > 2 else None
                changes.append(f"–õ–æ–∫–∞—Ü—ñ—è: {location}")
        
        # –û–Ω–æ–≤–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å
        if 'status' in data:
            inventory = db.query(DecorInventoryItem).filter(
                DecorInventoryItem.product_id == product_id
            ).first()
            if not inventory:
                inventory = DecorInventoryItem(
                    id=f"INV-{uuid.uuid4().hex[:8].upper()}",
                    product_id=product_id,
                    inventory_code=f"AUTO-{product_id}",
                    status='available'
                )
                db.add(inventory)
            
            old_status = inventory.audit_status
            inventory.audit_status = data['status']
            changes.append(f"–°—Ç–∞—Ç—É—Å: {old_status} ‚Üí {data['status']}")
        
        # –û–Ω–æ–≤–∏—Ç–∏ –Ω–æ—Ç–∞—Ç–∫–∏
        if 'notes' in data:
            inventory = db.query(DecorInventoryItem).filter(
                DecorInventoryItem.product_id == product_id
            ).first()
            if inventory:
                inventory.audit_notes = data['notes']
                changes.append("–ù–æ—Ç–∞—Ç–∫–∏ –æ–Ω–æ–≤–ª–µ–Ω–æ")
        
        # –ó–∞–ø–∏—Å–∞—Ç–∏ –≤ —ñ—Å—Ç–æ—Ä—ñ—é
        if changes:
            history = DecorProductHistory(
                id=f"H-{uuid.uuid4().hex[:8].upper()}",
                product_id=product_id,
                event_type='edited',
                actor=data.get('actor', '–†–µ–∫–≤—ñ–∑–∏—Ç–æ—Ä'),
                notes=f"–ú–∞—Å–æ–≤–µ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è: {', '.join(changes)}"
            )
            db.add(history)
        
        db.commit()
        
        return {
            'success': True,
            'product_id': product_id,
            'changes': changes,
            'message': '–î–∞–Ω—ñ –æ–Ω–æ–≤–ª–µ–Ω–æ'
        }
        
    except Exception as e:
        db.rollback()
        raise HTTPException(status_code=500, detail=f"–ü–æ–º–∏–ª–∫–∞: {str(e)}")



@router.get("/categories")
async def get_audit_categories(db: Session = Depends(get_db)):
    """
    –û—Ç—Ä–∏–º–∞—Ç–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–∞—Ç–µ–≥–æ—Ä—ñ–π —Ç–∞ –ø—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ–π –¥–ª—è —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó
    """
    try:
        # –û—Ç—Ä–∏–º–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ –≥–æ–ª–æ–≤–Ω—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó (parent_id = 0) - 1 –∑–∞–ø–∏—Ç
        main_categories_query = db.execute(text("""
            SELECT DISTINCT cd.name, c.category_id
            FROM oc_category c
            JOIN oc_category_description cd ON c.category_id = cd.category_id AND cd.language_id = 4
            WHERE c.parent_id = 0 AND c.status = 1
            ORDER BY cd.name
        """))
        
        main_categories_list = [(row[0], row[1]) for row in main_categories_query if row[0]]
        main_categories = [cat[0] for cat in main_categories_list]
        
        # –°—Ç–≤–æ—Ä–∏—Ç–∏ –º–∞–ø—É category_id -> name –¥–ª—è —à–≤–∏–¥–∫–æ–≥–æ –ø–æ—à—É–∫—É
        cat_id_to_name = {cat_id: cat_name for cat_name, cat_id in main_categories_list}
        
        # –û—Ç—Ä–∏–º–∞—Ç–∏ –í–°–Ü –ø—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –æ–¥–Ω–∏–º –∑–∞–ø–∏—Ç–æ–º - 1 –∑–∞–ø–∏—Ç
        all_subcategories_query = db.execute(text("""
            SELECT 
                sub_c.parent_id,
                sub_cd.name
            FROM oc_category sub_c
            JOIN oc_category_description sub_cd ON sub_c.category_id = sub_cd.category_id AND sub_cd.language_id = 4
            WHERE sub_c.parent_id IN :parent_ids AND sub_c.status = 1
            ORDER BY sub_c.parent_id, sub_cd.name
        """), {"parent_ids": tuple([cat_id for _, cat_id in main_categories_list])})
        
        # –ó–≥—Ä—É–ø—É–≤–∞—Ç–∏ –ø—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –ø–æ –≥–æ–ª–æ–≤–Ω—ñ–π –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó
        subcategories_dict = {}
        for parent_id, subcat_name in all_subcategories_query:
            parent_name = cat_id_to_name.get(parent_id)
            if parent_name:
                if parent_name not in subcategories_dict:
                    subcategories_dict[parent_name] = []
                subcategories_dict[parent_name].append(subcat_name)
        
        return {
            'categories': main_categories,
            'subcategories': subcategories_dict
        }
        
    except Exception as e:
        raise HTTPException(
            status_code=500,
            detail=f"–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π: {str(e)}"
        )

