{% extends '_base.html' %}
{% block title %}–ê–∫—Ç –ø–µ—Ä–µ–¥–∞—á—ñ {{ issue_card.order_number }}{% endblock %}
{% block extra_styles %}
<style>
    .damage-badge { background: #fff3e0; color: #e65100; padding: 2px 8px; border-radius: 4px; font-size: 8pt; }
    .no-damage { color: #388e3c; }
    .has-damage { color: #e65100; }
    .damage-note { background: #fff8e1; border-left: 3px solid #ffc107; padding: 8px 12px; margin-top: 5px; font-size: 9pt; }
</style>
{% endblock %}
{% block content %}
<div class="header">
    <div>
        <div class="logo">FarforRent</div>
        <div class="logo-sub">–û—Ä–µ–Ω–¥–∞ –¥–µ–∫–æ—Ä—É</div>
    </div>
    <div class="doc-info">
        <div class="doc-number">{{ doc_number }}</div>
        <div class="doc-date">{{ generated_at }}</div>
    </div>
</div>

<h1>–ê–ö–¢ –ü–†–ò–ô–ú–ê–ù–ù–Ø-–ü–ï–†–ï–î–ê–ß–Ü</h1>

<table class="mb-4">
    <tr><td style="width:150px">–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è:</td><td class="font-bold">{{ issue_card.order_number }}</td></tr>
    <tr><td>–ö–ª—ñ—î–Ω—Ç:</td><td class="font-bold">{{ issue_card.customer_name }}</td></tr>
    <tr><td>–¢–µ–ª–µ—Ñ–æ–Ω:</td><td>{{ issue_card.customer_phone }}</td></tr>
    <tr><td>–ü–µ—Ä—ñ–æ–¥ –æ—Ä–µ–Ω–¥–∏:</td><td>{{ issue_card.rental_start_date }} ‚Äî {{ issue_card.rental_end_date }}</td></tr>
    <tr><td>–í–∏–¥–∞—á–∞:</td><td>{{ issue_card.issued_at or generated_at }}</td></tr>
</table>

<h2>–ü–µ—Ä–µ–¥–∞–Ω—ñ —Ç–æ–≤–∞—Ä–∏</h2>
<table>
    <thead>
        <tr>
            <th style="width:30px">‚Ññ</th>
            <th>–ù–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—è</th>
            <th style="width:70px">SKU</th>
            <th style="width:50px">–ö-—Å—Ç—å</th>
            <th style="width:150px">–°—Ç–∞–Ω –ø—Ä–∏ –≤–∏–¥–∞—á—ñ</th>
        </tr>
    </thead>
    <tbody>
        {% for item in items %}
        {% set damages = item.get('pre_damage', []) %}
        <tr>
            <td class="text-center">{{ loop.index }}</td>
            <td>{{ item.get('name', '') }}</td>
            <td>{{ item.get('sku') or item.get('article', '') }}</td>
            <td class="text-center">{{ item.get('picked_qty') or item.get('quantity') or item.get('qty', 1) }}</td>
            <td>
                {% if damages and damages|length > 0 %}
                    <span class="has-damage">‚ö†Ô∏è –ó–∞—Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ: {{ damages|length }}</span>
                {% else %}
                    <span class="no-damage">‚úì –ë–µ–∑ –¥–µ—Ñ–µ–∫—Ç—ñ–≤</span>
                {% endif %}
            </td>
        </tr>
        {% if damages and damages|length > 0 %}
        <tr>
            <td colspan="5" style="padding: 0 0 10px 40px;">
                <div class="damage-note">
                    <strong>–Ü—Å–Ω—É—é—á—ñ –¥–µ—Ñ–µ–∫—Ç–∏:</strong>
                    {% for d in damages %}
                        {{ d.get('damage_type', d.get('type', '–¥–µ—Ñ–µ–∫—Ç')) }}{% if d.get('note') %} ({{ d.note }}){% endif %}{% if not loop.last %}, {% endif %}
                    {% endfor %}
                </div>
            </td>
        </tr>
        {% endif %}
        {% endfor %}
    </tbody>
</table>

<div class="mt-4">
    <p><strong>–í—Å—å–æ–≥–æ –ø–æ–∑–∏—Ü—ñ–π:</strong> {{ items|length }}</p>
    <p><strong>–í—Å—å–æ–≥–æ –æ–¥–∏–Ω–∏—Ü—å:</strong> {% set total = namespace(value=0) %}{% for item in items %}{% set total.value = total.value + (item.get('picked_qty') or item.get('quantity') or item.get('qty', 1)) %}{% endfor %}{{ total.value }}</p>
</div>

{% set items_with_damage = [] %}
{% for item in items %}
    {% if (item.get('pre_damage') and item.get('pre_damage')|length > 0) or (item.get('damage_history') and item.get('damage_history')|length > 0) %}
        {% set _ = items_with_damage.append(item) %}
    {% endif %}
{% endfor %}

{% if items_with_damage|length > 0 %}
<div style="background: #fff3e0; border: 1px solid #ffcc80; border-radius: 8px; padding: 12px; margin-top: 15px;">
    <p class="font-bold" style="color: #e65100;">‚ö†Ô∏è –£–í–ê–ì–ê: –ó–∞—Ñ—ñ–∫—Å–æ–≤–∞–Ω—ñ —ñ—Å–Ω—É—é—á—ñ –¥–µ—Ñ–µ–∫—Ç–∏</p>
    <p class="text-sm">–£ {{ items_with_damage|length }} –ø–æ–∑–∏—Ü—ñ—ó(—è—Ö) –∑–∞—Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ —ñ—Å–Ω—É—é—á—ñ –¥–µ—Ñ–µ–∫—Ç–∏. 
    –ö–ª—ñ—î–Ω—Ç –Ω–µ –Ω–µ—Å–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–æ—Å—Ç—ñ –∑–∞ —Ü—ñ –ø–æ—à–∫–æ–¥–∂–µ–Ω–Ω—è –ø—Ä–∏ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—ñ.</p>
    
    <!-- –î–µ—Ç–∞–ª—å–Ω–∞ —ñ—Å—Ç–æ—Ä—ñ—è –ø–æ—à–∫–æ–¥–∂–µ–Ω—å -->
    <div style="margin-top: 15px;">
        {% for item in items_with_damage %}
        <div style="background: #fff; border: 1px solid #ffd54f; border-radius: 6px; padding: 10px; margin-bottom: 10px;">
            <p class="font-bold" style="margin-bottom: 5px;">{{ item.get('name', '') }} ({{ item.get('sku', '') }})</p>
            {% set all_damages = (item.get('damage_history') or item.get('pre_damage') or []) %}
            {% for d in all_damages %}
            <div style="display: flex; gap: 10px; margin-bottom: 8px; padding: 8px; background: #fffde7; border-radius: 4px;">
                {% if d.get('photo_url') %}
                <img src="{{ d.get('photo_url') }}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px; border: 1px solid #ffc107;" alt="–§–æ—Ç–æ">
                {% endif %}
                <div>
                    <p style="font-weight: 500; color: #e65100;">{{ d.get('damage_type', d.get('type', '–î–µ—Ñ–µ–∫—Ç')) }}</p>
                    {% if d.get('note') %}<p style="font-size: 10px; color: #666;">{{ d.get('note') }}</p>{% endif %}
                    <p style="font-size: 9px; color: #999;">
                        {% if d.get('order_number') %}–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è: {{ d.get('order_number') }} ¬∑ {% endif %}
                        {{ d.get('stage_label', d.get('stage', '')) }} ¬∑ {{ d.get('created_at', '') }}
                        {% if d.get('created_by') %} ¬∑ {{ d.get('created_by') }}{% endif %}
                    </p>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endfor %}
    </div>
</div>
{% else %}
<div style="background: #e8f5e9; border: 1px solid #a5d6a7; border-radius: 8px; padding: 12px; margin-top: 15px;">
    <p class="font-bold" style="color: #2e7d32;">‚úì –í—Å—ñ —Ç–æ–≤–∞—Ä–∏ –ø–µ—Ä–µ–¥–∞–Ω–æ –±–µ–∑ –∑–∞—Ñ—ñ–∫—Å–æ–≤–∞–Ω–∏—Ö –¥–µ—Ñ–µ–∫—Ç—ñ–≤</p>
    <p class="text-sm">–û—Ä–µ–Ω–¥–∞—Ä –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂—É—î –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ç–æ–≤–∞—Ä—ñ–≤ —É –Ω–∞–ª–µ–∂–Ω–æ–º—É —Å—Ç–∞–Ω—ñ.</p>
</div>
{% endif %}

<div class="highlight" style="padding:10px; margin-top:20px;">
    <p class="font-bold">üìã –£–º–æ–≤–∏:</p>
    <p class="text-sm">–ü—ñ–¥–ø–∏—Å—É—é—á–∏ —Ü–µ–π –∞–∫—Ç, –û—Ä–µ–Ω–¥–∞—Ä –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂—É—î –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ç–æ–≤–∞—Ä—ñ–≤ —Ç–∞ –±–µ—Ä–µ –Ω–∞ —Å–µ–±–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω—ñ—Å—Ç—å –∑–∞ —ó—Ö –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –Ω–∞ –ø–µ—Ä—ñ–æ–¥ –æ—Ä–µ–Ω–¥–∏.</p>
</div>

<div class="signatures">
    <div class="signature-block">
        <p class="font-bold">–ü–ï–†–ï–î–ê–í (–û—Ä–µ–Ω–¥–æ–¥–∞–≤–µ—Ü—å):</p>
        <div class="signature-line"></div>
        <div class="signature-label">–ø—ñ–¥–ø–∏—Å / –ü–Ü–ë</div>
    </div>
    <div class="signature-block">
        <p class="font-bold">–û–¢–†–ò–ú–ê–í (–û—Ä–µ–Ω–¥–∞—Ä):</p>
        <p class="text-sm">{{ issue_card.customer_name }}</p>
        <div class="signature-line"></div>
        <div class="signature-label">–ø—ñ–¥–ø–∏—Å</div>
    </div>
</div>
{% endblock %}